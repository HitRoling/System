<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Insurance Management Portal</title>
    
    <!-- Authentication Check -->
    <script>
        (function () {
            try {
                // Log the start of the authentication check
                console.log('Checking authentication...');

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));

                // If no user is logged in or no company is specified, redirect to login.html
                if (!currentUser || !currentUser.company) {
                    console.log('No user or company found. Redirecting to login.html...');
                    window.location.href = 'login.html';
                    return;
                }

                // Log the current user details for debugging
                console.log('Logged in as:', currentUser.username, 'Company:', currentUser.company);
            } catch (error) {
                console.error('Error during authentication check:', error);
                window.location.href = 'login.html';
            }
        })();
    </script>

    <!-- CSS Styles -->
    <style>
        /* General Styles */
        * {
            box-sizing: border-box;
        }
        body {
            display: flex;
            margin: 0;
            font-family: Arial, sans-serif;
            color: #333;
            background-color: #f0f2f5;
        }
        a {
            text-decoration: none;
            color: inherit;
        }
        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 250px;
            width: calc(100% - 250px);
            background-color: #f8f9fa;
            padding: 10px 20px;
            z-index: 999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img {
            height: 50px;
            margin-right: 20px;
        }
        .header h1 {
            flex-grow: 1;
            font-size: 24px;
        }
        .header .logout-btn {
            background-color: #dc3545;
            border: none;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        .header .logout-btn:hover {
            background-color: #c82333;
        }
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            position: fixed;
            top: 0;
            bottom: 0;
            overflow-y: auto;
            transition: width 0.2s;
            color: white;
            z-index: 1000;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar .toggle-btn {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
        }
        .sidebar .toggle-btn button {
            background-color: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
        }
        .sidebar .menu-item {
            padding: 15px 20px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .sidebar .menu-item:hover, .sidebar .menu-item.active {
            background-color: #495057;
        }
        .sidebar .menu-item .arrow {
            margin-left: auto;
            transition: transform 0.2s;
        }
        .sidebar .menu-item.open .arrow {
            transform: rotate(90deg);
        }
        .sidebar .submenu {
            display: none;
            flex-direction: column;
            background-color: #495057;
        }
        .sidebar .submenu.open {
            display: flex;
        }
        .sidebar .submenu .menu-item {
            padding-left: 40px;
            font-size: 14px;
        }
        /* Hamburger Menu for Responsive Design */
        .hamburger {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            cursor: pointer;
            z-index: 1100;
        }

        .hamburger i {
            color: #fff;
            font-size: 24px;
        }

        @media screen and (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .sidebar.collapsed {
                width: 0;
            }

            .hamburger {
                display: block;
            }

            .header {
                left: 60px;
                width: calc(100% - 60px);
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                margin-top: 10px;
            }

            .content {
                margin-left: 60px;
                width: calc(100% - 60px);
            }

            .sidebar.collapsed + .content {
                margin-left: 0;
                width: 100%;
            }

            .widgets {
                flex-direction: column;
            }
            .widget {
                width: 100%;
            }
            .form-group {
                flex-direction: column;
            }
            .form-group label, .form-group input, .form-group select, .form-group textarea {
                width: 100%;
            }
        }

        /* Content */
        .content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
            margin-top: 80px;
            transition: margin-left 0.2s;
            min-height: 100vh;
            overflow: auto;
        }
        .content.collapsed {
            margin-left: 60px;
            width: calc(100% - 60px);
        }
        /* Sections */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Widgets */
        .widgets {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .widget {
            flex: 1;
            min-width: 250px;
            background-color: #3e536c;
            color: white;
            padding: 20px;
            border-radius: 8px;
            position: relative;
            text-align: center;
        }
        .widget h3 {
            margin-top: 0;
            font-size: 24px;
        }
        .widget p {
            font-size: 36px;
            margin: 0;
        }
        /* Forms and Tables */
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control, select, textarea {
            padding: 12px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-control:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3e536c;
        }
        .tooltip {
            position: absolute;
            top: -5px;
            right: 10px;
            background-color: #3e536c;
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            display: none;
            z-index: 1002;
        }
        .form-group:hover .tooltip {
            display: block;
        }
        .btn {
            padding: 8px 12px;
            margin: 2px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        /* Tables */
        .table, .clients-table, .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .table th, .table td, .clients-table th, .clients-table td, .history-table th, .history-table td {
            padding: 12px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        .table th, .clients-table th, .history-table th {
            background-color: #e9ecef;
            color: #495057;
            cursor: pointer;
            position: relative;
        }
        .table tr:nth-child(even), .clients-table tr:nth-child(even), .history-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }
        .status-closed {
            background-color: #6c757d;
        }
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
        }
        .modal-content .close-btn {
            position: absolute;
            right: 15px;
            top: 10px;
            background-color: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        /* Alerts */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: white;
        }
        .alert-success {
            background-color: #28a745;
        }
        .alert-error {
            background-color: #dc3545;
        }
        /* Tooltips */
        .has-tooltip {
            position: relative;
        }
        .has-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #3e536c;
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1002;
        }
        /* Responsive */
        @media screen and (max-width: 1024px) {
            .widgets {
                flex-direction: column;
            }
            .widget {
                width: 100%;
            }
        }
        /* Filter Buttons */
        .filter-button {
            background-color: darkblue;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .filter-button.active {
            background-color: lightblue;
        }
        /* Search Bar */
        .search-bar {
            display: flex;
            margin: 10px 0;
        }
        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }
        .search-bar button {
            background-color: blue;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }
        /* Info Columns in Header */
        .info-columns {
            display: flex;
            gap: 20px;
        }
        .info-table {
            width: 300px;
            border-collapse: collapse;
        }
        .info-table th, .info-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .info-table th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        /* Tabs Styling */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .tab-button {
            background-color: #f1f1f1;
            border: none;
            outline: none;
            padding: 14px 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 17px;
        }
        .tab-button.active {
            background-color: #ccc;
        }
        /* Recent Activities */
        .recent-activities {
            margin-top: 20px;
        }
        .recent-activities ul {
            list-style: none;
            padding: 0;
        }
        .recent-activities li {
            background-color: #fff;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* Dashboard Summary Boxes */
        .dashboard {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .summary-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            width: 18%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        .summary-box h3 {
            margin-bottom: 10px;
        }
        /* Pagination Controls */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
        }
        .pagination .btn {
            margin: 0 5px;
        }
        /* Financial Reports Chart */
        #financialChart {
            max-width: 100%;
            height: 400px;
        }
    </style>

    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Add custom CSS for styling the sidebar and content -->
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
        }
        /* Sidebar Styles */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 240px;
            background-color: #2c3e50; /* Dark navy */
            color: #ecf0f1; /* Light text */
            overflow-y: auto;
            transition: all 0.3s;
        }
        #sidebar .sidebar-header {
            padding: 20px;
            background: #1a252f;
            text-align: center;
        }
        #sidebar ul.components {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        #sidebar ul li {
            padding: 15px;
            font-size: 1.1em;
        }
        #sidebar ul li a {
            color: #ecf0f1;
            text-decoration: none;
            display: block;
        }
        #sidebar ul li a:hover {
            background: #1abc9c;
            color: #fff;
        }
        #sidebar ul li.active > a {
            background: #1abc9c;
            color: #fff;
        }
        #sidebar ul li a.collapsed::after {
            content: '\f078';
            font-family: FontAwesome;
            float: right;
        }
        #sidebar ul li a[aria-expanded="true"]::after {
            content: '\f077';
        }
        /* Main content */
        #content {
            margin-left: 240px;
            padding: 20px;
            transition: all 0.3s;
        }
        /* Active section */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* ...additional custom styles... */
    </style>
    <!-- Include FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>
    <!-- Hamburger Menu for Mobile -->
    <div class="hamburger">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Header -->
    <div class="header">
        <img src="https://i.imgur.com/2zHxp8T.png" alt="Company Logo"> <!-- Corrected Image URL -->
        <h1>Insurance Management Portal</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
        <div class="info-columns">
            <table class="info-table">
                <thead>
                    <tr>
                        <th>Client No.</th>
                        <th>Client Name</th>
                        <th>Commission</th>
                    </tr>
                </thead>
                <tbody id="clientInfo">
                    <!-- Client info will be populated here -->
                </tbody>
            </table>
            <table class="info-table">
                <thead>
                    <tr>
                        <th>Policy No.</th>
                        <th>Claim No.</th>
                        <th>Product Info</th>
                        <th>Status</th>
                        <th>Loss Ratio</th>
                    </tr>
                </thead>
                <tbody id="policyClaimInfo">
                    <!-- Policy and claim info will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>Insurance Management Portal</h3>
        </div>
        <ul class="list-unstyled components">
            <li class="active">
                <a href="#" onclick="showSection('dashboard')">Dashboard</a>
            </li>
            <li>
                <a href="#clientSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="collapsed">Client Management</a>
                <ul class="collapse list-unstyled" id="clientSubmenu">
                    <li>
                        <a href="#" onclick="showSection('clients-list')">Clients List</a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('add-client')">Add New Client</a>
                    </li>
                    <!-- ...other submenu items... -->
                </ul>
            </li>
            <li>
                <a href="#policySubmenu" data-bs-toggle="collapse" aria-expanded="false" class="collapsed">Policy Accounts</a>
                <ul class="collapse list-unstyled" id="policySubmenu">
                    <li>
                        <a href="#" onclick="showSection('policies-list')">Policy List</a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('create-policy')">Create Policy</a>
                    </li>
                    <!-- ...other submenu items... -->
                </ul>
            </li>
            <li>
                <a href="#claimsSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="collapsed">Claims Management</a>
                <ul class="collapse list-unstyled" id="claimsSubmenu">
                    <li>
                        <a href="#" onclick="showSection('claims-list')">Current Claims</a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('submit-claim')">Submit Claim</a>
                    </li>
                    <!-- ...other submenu items... -->
                </ul>
            </li>
            <li>
                <a href="#reportsSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="collapsed">Reports</a>
                <ul class="collapse list-unstyled" id="reportsSubmenu">
                    <li>
                        <a href="#" onclick="showSection('run-report')">Run Report</a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('loss-ratio')">Loss Ratio Analysis</a>
                    </li>
                    <!-- ...other submenu items... -->
                </ul>
            </li>
            <!-- ...additional menu items... -->
        </ul>
    </nav>

    <!-- Main Content -->
    <div id="content">
        <!-- Dashboard Section -->
        <section id="dashboard-section" class="mt-4 active">
            <h2>Dashboard</h2>
            <!-- Overview Widgets -->
            <div class="widgets">
                <div class="widget">
                    <h3>Total Clients</h3>
                    <p id="totalClients">0</p>
                </div>
                <div class="widget">
                    <h3>Active Policies</h3>
                    <p id="activePolicies">0</p>
                </div>
                <div class="widget">
                    <h3>Pending Claims</h3>
                    <p id="pendingClaims">0</p>
                </div>
                <div class="widget">
                    <h3>Notifications</h3>
                    <p id="notifications">0</p>
                </div>
            </div>
            <!-- Recent Activities -->
            <h3>Recent Activities</h3>
            <ul id="recentActivities">
                <!-- Activities will be loaded here -->
            </ul>
        </section>

        <!-- Client Search Section -->
        <section id="client-search-section" class="mt-4 section d-none">
            <h2>Client Search</h2>
            <div class="form-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, phone, VAT number, or vehicle registration">
                <small class="error" id="searchError" style="color: red;"></small>
                <span class="tooltip">Enter keywords to search clients.</span>
            </div>
            <button class="btn" onclick="performSearch()">Search</button>
            <div id="searchResults" style="margin-top: 20px;">
                <!-- Search results will appear here -->
            </div>
        </section>

        <!-- Add New Client Section -->
        <div id="add-client-section" class="section d-none">
            <h2>Add New Client</h2>
            <form id="newClientForm">
                <div class="form-group">
                    <label for="clientName">Name:</label>
                    <input type="text" id="clientName" class="form-control" required>
                    <small class="error" id="nameError" style="color: red;"></small>
                    <span class="tooltip">Enter the client's full name.</span>
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email:</label>
                    <input type="email" id="clientEmail" class="form-control" required>
                    <small class="error" id="emailError" style="color: red;"></small>
                    <span class="tooltip">Enter a valid email address.</span>
                </div>
                <div class="form-group">
                    <label for="clientPhone">Phone:</label>
                    <input type="text" id="clientPhone" class="form-control" required>
                    <small class="error" id="phoneError" style="color: red;"></small>
                    <span class="tooltip">Enter a valid phone number.</span>
                </div>
                <div class="form-group">
                    <label for="clientVAT">VAT Number:</label>
                    <input type="text" id="clientVAT" class="form-control">
                    <span class="tooltip">Enter the client's VAT number.</span>
                </div>
                <div class="form-group">
                    <label for="clientVehicle">Vehicle Registration:</label>
                    <input type="text" id="clientVehicle" class="form-control">
                    <span class="tooltip">Enter the vehicle registration number.</span>
                </div>
                <div class="form-group">
                    <label for="clientAddress">Address:</label>
                    <input type="text" id="clientAddress" class="form-control">
                    <span class="tooltip">Enter the client's address.</span>
                </div>
                <button type="submit" class="btn">Add Client</button>
            </form>
        </div>

        <!-- Client List Section -->
        <section id="clientsList-section" class="mt-4 section d-none">
            <h2>Client List</h2>
            <div style="margin-bottom: 10px;">
                <button class="btn" onclick="exportClients()">Export</button>
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importClients(event)">
                <button class="btn" onclick="document.getElementById('importFile').click()">Import</button>
            </div>
            <table class="clients-table" id="clientsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('clientsTable', 0)">Name</th>
                        <th onclick="sortTable('clientsTable', 1)">Email</th>
                        <th onclick="sortTable('clientsTable', 2)">Phone</th>
                        <th onclick="sortTable('clientsTable', 3)">VAT Number</th>
                        <th onclick="sortTable('clientsTable', 4)">Vehicle Reg.</th>
                        <th onclick="sortTable('clientsTable', 5)">Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Client list will be populated here -->
                </tbody>
            </table>
        </section>

        <!-- Create Policy Section -->
        <div id="create-policy-section" class="section d-none">
            <h2>Create Policy</h2>
            <form id="createPolicyForm">
                <div class="form-group">
                    <label for="policyClient">Select Client:</label>
                    <select id="policyClient" class="form-control" required>
                        <!-- Client options will be populated here -->
                    </select>
                    <span class="tooltip">Choose a client from the list.</span>
                </div>
                <div class="form-group">
                    <label for="policyType">Policy Type:</label>
                    <select id="policyType" class="form-control" required>
                        <option value="">Select Policy Type</option>
                        <option value="Auto Insurance">Auto Insurance</option>
                        <option value="Home Insurance">Home Insurance</option>
                        <option value="Life Insurance">Life Insurance</option>
                        <option value="Health Insurance">Health Insurance</option>
                    </select>
                    <span class="tooltip">Select the type of policy.</span>
                </div>
                <div class="form-group">
                    <label for="coverageAmount">Coverage Amount:</label>
                    <input type="number" id="coverageAmount" class="form-control" required>
                    <span class="tooltip">Enter the coverage amount.</span>
                </div>
                <div class="form-group">
                    <label for="premium">Premium:</label>
                    <input type="number" id="premium" class="form-control" required>
                    <span class="tooltip">Enter the premium amount.</span>
                </div>
                <button type="submit" class="btn">Create Policy</button>
            </form>
        </div>

        <!-- Update Policy Section -->
        <div id="update-policy-section" class="section d-none">
            <h2>Update Policy</h2>
            <div class="form-group">
                <label for="policySearch">Search Policy:</label>
                <input type="text" id="policySearch" class="form-control" placeholder="Search by policy number or client name">
                <span class="tooltip">Enter keywords to search policies.</span>
            </div>
            <button class="btn" onclick="searchPolicies()">Search</button>
            <div id="policyResults" style="margin-top: 20px;">
                <!-- Policy search results will appear here -->
            </div>
        </div>

        <!-- Manage Policies Section -->
        <div id="manage-policies-section" class="section d-none">
            <h2>Manage Policies</h2>
            <table class="table" id="policiesTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('policiesTable', 0)">Policy Number</th>
                        <th onclick="sortTable('policiesTable', 1)">Client</th>
                        <th onclick="sortTable('policiesTable', 2)">Type</th>
                        <th onclick="sortTable('policiesTable', 3)">Coverage</th>
                        <th onclick="sortTable('policiesTable', 4)">Premium</th>
                        <th onclick="sortTable('policiesTable', 5)">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Policies will be populated here -->
                </tbody>
            </table>
            <!-- Pagination Controls -->
            <div class="pagination">
                <button class="btn" onclick="prevPage('policiesTable')">Previous</button>
                <span id="policiesPageInfo">Page 1 of 1</span>
                <button class="btn" onclick="nextPage('policiesTable')">Next</button>
            </div>
        </div>

        <!-- Submit Claim Section -->
        <div id="submit-claim-section" class="section d-none">
            <h2>Submit Claim</h2>
            <form id="submitClaimForm">
                <div class="form-group">
                    <label for="claimPolicy">Select Policy:</label>
                    <select id="claimPolicy" class="form-control" required>
                        <!-- Policy options will be populated here -->
                    </select>
                    <span class="tooltip">Choose a policy for the claim.</span>
                </div>
                <div class="form-group">
                    <label for="claimDate">Date of Incident:</label>
                    <input type="date" id="claimDate" class="form-control" required>
                    <span class="tooltip">Select the date of the incident.</span>
                </div>
                <div class="form-group">
                    <label for="claimDescription">Description:</label>
                    <textarea id="claimDescription" class="form-control" required></textarea>
                    <span class="tooltip">Provide details of the incident.</span>
                </div>
                <div class="form-group">
                    <label for="claimDocuments">Upload Documents:</label>
                    <input type="file" id="claimDocuments" class="form-control" multiple>
                    <span class="tooltip">Attach supporting documents.</span>
                </div>
                <button type="submit" class="btn">Submit Claim</button>
            </form>
        </div>

        <!-- Track Claims Section -->
        <div id="track-claims-section" class="section d-none">
            <h2>Track Claims</h2>
            <table class="table" id="claimsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('claimsTable', 0)">Claim Number</th>
                        <th onclick="sortTable('claimsTable', 1)">Policy Number</th>
                        <th onclick="sortTable('claimsTable', 2)">Date of Incident</th>
                        <th onclick="sortTable('claimsTable', 3)">Description</th>
                        <th onclick="sortTable('claimsTable', 4)">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Claims will be populated here -->
                </tbody>
            </table>
            <!-- Pagination Controls -->
            <div class="pagination">
                <button class="btn" onclick="prevPage('claimsTable')">Previous</button>
                <span id="claimsPageInfo">Page 1 of 1</span>
                <button class="btn" onclick="nextPage('claimsTable')">Next</button>
            </div>
        </div>

        <!-- Resolve Claims Section -->
        <div id="resolve-claims-section" class="section d-none">
            <h2>Resolve Claims</h2>
            <table class="table" id="resolveClaimsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('resolveClaimsTable', 0)">Claim Number</th>
                        <th onclick="sortTable('resolveClaimsTable', 1)">Policy Number</th>
                        <th onclick="sortTable('resolveClaimsTable', 2)">Date of Incident</th>
                        <th onclick="sortTable('resolveClaimsTable', 3)">Description</th>
                        <th onclick="sortTable('resolveClaimsTable', 4)">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Claims to resolve will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Premium Calculator Section -->
        <div id="premium-calculator-section" class="section d-none">
            <h2>Premium Calculator</h2>
            <form id="premiumCalculatorForm">
                <div class="form-group">
                    <label for="calculatorPolicyType">Policy Type:</label>
                    <select id="calculatorPolicyType" class="form-control" required>
                        <option value="">Select Policy Type</option>
                        <option value="Auto Insurance">Auto Insurance</option>
                        <option value="Home Insurance">Home Insurance</option>
                        <option value="Life Insurance">Life Insurance</option>
                        <option value="Health Insurance">Health Insurance</option>
                    </select>
                    <span class="tooltip">Select the type of policy.</span>
                </div>
                <div class="form-group">
                    <label for="calculatorCoverageAmount">Coverage Amount:</label>
                    <input type="number" id="calculatorCoverageAmount" class="form-control" required>
                    <span class="tooltip">Enter the desired coverage amount.</span>
                </div>
                <button type="submit" class="btn">Calculate Premium</button>
            </form>
            <div id="premiumResult" style="margin-top: 20px;">
                <!-- Premium calculation result will appear here -->
            </div>
        </div>

        <!-- Billing Section -->
        <div id="billing-section" class="section d-none">
            <h2>Billing</h2>
            <table class="table" id="billingTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('billingTable', 0)">Invoice Number</th>
                        <th onclick="sortTable('billingTable', 1)">Client</th>
                        <th onclick="sortTable('billingTable', 2)">Amount</th>
                        <th onclick="sortTable('billingTable', 3)">Due Date</th>
                        <th onclick="sortTable('billingTable', 4)">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Billing entries will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Financial Reports Section -->
        <div id="financial-reports-section" class="section d-none">
            <h2>Financial Reports</h2>
            <canvas id="financialChart" width="400" height="200"></canvas>
        </div>

        <!-- Complaints Management Section -->
        <section id="complaints-section" class="mt-4 section d-none">
            <h2>Complaints Management</h2>
            <!-- Implement Complaints Management functionalities here -->
            <!-- This can include listing complaints, adding new ones, etc. -->
        </section>

        <!-- View Account Section -->
        <section id="viewAccount-section" class="mt-4 section d-none">
            <h2>View Account</h2>
            <!-- Implement View Account functionalities here -->
            <!-- This can include viewing account details, editing information, etc. -->
        </section>

        <!-- Refunds Section -->
        <section id="refunds-section" class="mt-4 section d-none">
            <h2>Refunds</h2>
            <!-- Implement Refunds functionalities here -->
            <!-- This can include processing refunds, listing refund history, etc. -->
        </section>

        <!-- Current Claims Section -->
        <section id="currentClaims-section" class="mt-4 section d-none">
            <h2>Current Claims</h2>
            <!-- Implement Current Claims functionalities here -->
            <!-- This can include listing current claims, updating statuses, etc. -->
        </section>

        <!-- Claims Details Section -->
        <section id="claimsDetails-section" class="mt-4 section d-none">
            <h2>Claims Details</h2>
            <!-- Implement Claims Details functionalities here -->
            <!-- This can include detailed view of a specific claim, related information, etc. -->
        </section>

        <!-- Claims Endorsements Section -->
        <section id="claimsEndorsements-section" class="mt-4 section d-none">
            <h2>Claims Endorsements</h2>
            <!-- Implement Claims Endorsements functionalities here -->
            <!-- This can include adding endorsements to claims, listing endorsements, etc. -->
        </section>

        <!-- Claims Parties Section -->
        <section id="claimsParties-section" class="mt-4 section d-none">
            <h2>Claims Parties</h2>
            <!-- Implement Claims Parties functionalities here -->
            <!-- This can include managing parties involved in claims, communication logs, etc. -->
        </section>

        <!-- Run Report Section -->
        <section id="runReport-section" class="mt-4 section d-none">
            <h2>Run Report</h2>
            <form id="runReportForm">
                <div class="form-group">
                    <label for="reportType">Report Type:</label>
                    <select id="reportType" class="form-control" required>
                        <option value="">Select Report Type</option>
                        <option value="lossRatio">Loss Ratio</option>
                        <option value="policySummary">Policy Summary</option>
                        <!-- Add more report types as needed -->
                    </select>
                    <span class="tooltip">Choose the type of report to generate.</span>
                </div>
                <div class="form-group">
                    <label for="reportStartDate">Start Date:</label>
                    <input type="date" id="reportStartDate" class="form-control" required>
                    <span class="tooltip">Select the start date for the report.</span>
                </div>
                <div class="form-group">
                    <label for="reportEndDate">End Date:</label>
                    <input type="date" id="reportEndDate" class="form-control" required>
                    <span class="tooltip">Select the end date for the report.</span>
                </div>
                <button type="submit" class="btn">Generate Report</button>
            </form>
            <div id="reportResults" style="margin-top: 20px;">
                <!-- Report results will appear here -->
            </div>
        </section>

        <!-- Loss Ratio Analysis Section -->
        <section id="lossRatio-section" class="mt-4 section d-none">
            <h2>Loss Ratio Analysis</h2>
            <canvas id="loss-ratio-chart" width="400" height="200"></canvas>
        </section>

        <!-- Month-End Report History Section -->
        <section id="monthEndHistory-section" class="mt-4 section d-none">
            <h2>Month-End Report History</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Report ID</th>
                        <th>Report Type</th>
                        <th>Date Generated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="month-end-history-body">
                    <!-- Dynamic Reports -->
                </tbody>
            </table>
        </section>

        <!-- Manager Reports Section -->
        <section id="managerReports-section" class="mt-4 section d-none">
            <h2>Manager Reports</h2>
            <form id="manager-reports-form">
                <div class="form-group">
                    <label for="manager-report-type">Report Type:</label>
                    <select class="form-control" id="manager-report-type" required>
                        <option value="">Select Report Type</option>
                        <option value="agentPerformance">Agent Performance</option>
                        <option value="policyGrowth">Policy Growth</option>
                        <!-- Add more manager-specific report types as needed -->
                    </select>
                    <span class="tooltip">Choose the type of manager report to generate.</span>
                </div>
                <button type="submit" class="btn btn-success">Generate Manager Report</button>
            </form>
            <div id="manager-report-display" style="margin-top: 20px;">
                <h3>Manager Report: <span id="manager-report-title"></span></h3>
                <div id="manager-report-content">
                    <!-- Dynamic Manager Report Content -->
                </div>
            </div>
        </section>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Client Modal -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('clientModal')">&times;</button>
            <h2 id="clientModalLabel">Add New Client</h2>
            <form id="client-form">
                <div class="form-group">
                    <label for="modal-clientName">Client Name</label>
                    <input type="text" class="form-control" id="modal-clientName" required>
                </div>
                <div class="form-group">
                    <label for="modal-idNumber">ID Number</label>
                    <input type="text" class="form-control" id="modal-idNumber" required>
                </div>
                <div class="form-group">
                    <label for="modal-commission">Commission</label>
                    <input type="text" class="form-control" id="modal-commission" placeholder="$0.00" required>
                </div>
                <div class="form-group">
                    <label for="modal-productInfo">Product Info</label>
                    <input type="text" class="form-control" id="modal-productInfo" required>
                </div>
                <div class="form-group">
                    <label for="modal-lossRatio">Loss Ratio</label>
                    <input type="number" step="0.01" class="form-control" id="modal-lossRatio" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label for="modal-status">Status</label>
                    <select class="form-control" id="modal-status" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Pending">Pending</option>
                        <!-- Add more statuses as needed -->
                    </select>
                </div>
                <button type="submit" class="btn">Save Client</button>
            </form>
        </div>
    </div>

    <!-- Add Claim Modal -->
    <div class="modal" id="claimModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('claimModal')">&times;</button>
            <h2 id="claimModalLabel">Add New Claim</h2>
            <form id="claim-form">
                <div class="form-group">
                    <label for="modal-claim-client-no">Client Number</label>
                    <input type="text" class="form-control" id="modal-claim-client-no" placeholder="Enter client number" required>
                </div>
                <div class="form-group">
                    <label for="modal-claim-policy-no">Policy Number</label>
                    <input type="text" class="form-control" id="modal-claim-policy-no" placeholder="Enter policy number" required>
                </div>
                <div class="form-group">
                    <label for="modal-claim-status">Status</label>
                    <select class="form-control" id="modal-claim-status" required>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Closed">Closed</option>
                        <!-- Add more statuses as needed -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal-claim-date">Date Filed</label>
                    <input type="date" class="form-control" id="modal-claim-date" required>
                </div>
                <button type="submit" class="btn">Save Claim</button>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Data Handling
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let policies = JSON.parse(localStorage.getItem('policies')) || [];
        let claims = JSON.parse(localStorage.getItem('claims')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        let refunds = JSON.parse(localStorage.getItem('refunds')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let recentActivities = JSON.parse(localStorage.getItem('recentActivities')) || [];
        let monthEndReports = JSON.parse(localStorage.getItem('monthEndReports')) || [];
        let managerReports = JSON.parse(localStorage.getItem('managerReports')) || [];

        // Initialize the application
        function initializeApp() {
            loadClientList();
            loadPolicyList();
            loadClaimList();
            loadResolveClaimsList();
            loadClientOptions();
            loadPolicyOptions();
            loadRecentActivities();
            loadReports();
            loadClientInfo(); // Load client info in header
            loadRefundsList();
            loadComplaintsList();

            // Update widgets
            document.getElementById('totalClients').innerText = getCompanyClients().length;
            document.getElementById('activePolicies').innerText = getCompanyPolicies().length;
            document.getElementById('pendingClaims').innerText = getCompanyPendingClaims().length;
            document.getElementById('notifications').innerText = recentActivities.length; // Assuming notifications are based on recent activities

            // Initialize charts
            renderLossRatioChart();
            renderFinancialChart();
        }

        // Event listener for initial load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeButtonHandlers();
        });

        // Logout Function
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Sidebar Toggle
        document.getElementById('sidebarToggleBtn').addEventListener('click', function() {
            toggleSidebar();
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Hamburger Menu Toggle for Mobile
        document.querySelector('.hamburger').addEventListener('click', function() {
            toggleSidebar();
        });

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Navigation Functions
        function toggleSubmenu(element) {
            element.classList.toggle('open');
            const submenu = element.nextElementSibling;
            submenu.classList.toggle('open');
        }

        document.querySelectorAll('.sidebar .menu-item[data-toggle="submenu"]').forEach(item => {
            item.addEventListener('click', function() {
                toggleSubmenu(this);
            });
        });

        function showSection(sectionId) {
            // Remove active class from all menu items
            document.querySelectorAll('.sidebar .menu-item').forEach(item => item.classList.remove('active'));
            // Remove active class from all submenu items
            document.querySelectorAll('.sidebar .submenu .menu-item').forEach(item => item.classList.remove('active'));

            // Add active class to the corresponding menu item
            const activeMenuItem = document.querySelector(`.sidebar .menu-item[data-section="${sectionId}"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
                // Open the submenu if it's within one
                const parentSubmenu = activeMenuItem.closest('.submenu');
                if (parentSubmenu) {
                    parentSubmenu.classList.add('open');
                    const parentMenuItem = parentSubmenu.previousElementSibling;
                    parentMenuItem.classList.add('open');
                }
            }

            // Hide all sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            // Show selected section
            document.getElementById(`${sectionId}-section`).classList.add('active');
        }

        // Data Validation Functions
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const re = /^\+?\d{7,15}$/;
            return re.test(phone);
        }

        // Helper Functions to Get Company-Specific Data
        function getCurrentUser() {
            return JSON.parse(localStorage.getItem('currentUser'));
        }

        function getCompanyClients() {
            const currentUser = getCurrentUser();
            return clients.filter(client => client.company === currentUser.company);
        }

        function getCompanyPolicies() {
            const currentUser = getCurrentUser();
            return policies.filter(policy => {
                const client = clients.find(c => c.id === policy.clientId);
                return client && client.company === currentUser.company;
            });
        }

        function getCompanyClaims() {
            const companyPolicies = getCompanyPolicies();
            const companyPolicyNumbers = companyPolicies.map(p => p.policyNumber);
            return claims.filter(claim => companyPolicyNumbers.includes(claim.policyNumber));
        }

        function getCompanyPendingClaims() {
            return getCompanyClaims().filter(claim => claim.status !== 'Paid');
        }

        function getCompanyHistory() {
            const currentUser = getCurrentUser();
            return history.filter(entry => entry.company === currentUser.company);
        }

        // Client Functions
        document.getElementById('newClientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // Form Validation
            const name = document.getElementById('clientName').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const vatNumber = document.getElementById('clientVAT').value.trim();
            const vehicleReg = document.getElementById('clientVehicle').value.trim();
            const address = document.getElementById('clientAddress').value.trim();
            let valid = true;

            if (name === '') {
                document.getElementById('nameError').innerText = 'Name is required.';
                valid = false;
            } else {
                document.getElementById('nameError').innerText = '';
            }

            if (!validateEmail(email)) {
                document.getElementById('emailError').innerText = 'Invalid email address.';
                valid = false;
            } else {
                document.getElementById('emailError').innerText = '';
            }

            if (!validatePhone(phone)) {
                document.getElementById('phoneError').innerText = 'Invalid phone number.';
                valid = false;
            } else {
                document.getElementById('phoneError').innerText = '';
            }

            if (!valid) return;

            const currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            const clientNumber = generateClientNumber();

            const client = {
                id: Date.now(),
                clientNumber: clientNumber, // Add client number
                name: name,
                email: email,
                phone: phone,
                vatNumber: vatNumber,
                vehicleReg: vehicleReg,
                address: address,
                company: currentUser.company // Add company from current user
            };
            clients.push(client);
            localStorage.setItem('clients', JSON.stringify(clients));

            // Add to history
            addToHistory('Added new client', `Client Number: ${client.clientNumber}, Name: ${client.name}`);

            // Update total clients count
            document.getElementById('totalClients').innerText = getCompanyClients().length;

            // Update Info Columns
            displayClientInfo(client);

            // Reset form
            document.getElementById('newClientForm').reset();

            alert('Client added successfully!');
            loadClientOptions();
            loadClientList();
        });

        function loadClientList() {
            const tbody = document.getElementById('clientsTable').querySelector('tbody');
            tbody.innerHTML = '';

            const companyClients = getCompanyClients();

            companyClients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.email}</td>
                    <td>${client.phone}</td>
                    <td>${client.vatNumber || 'N/A'}</td>
                    <td>${client.vehicleReg || 'N/A'}</td>
                    <td>${client.address || 'N/A'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewClient(${client.id})">View</button>
                        <button class="btn" onclick="editClient(${client.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteClient(${client.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Initialize Pagination
            tablePageInfo['clientsTable'] = { currentPage: 1, rowsPerPage: 10 };
            paginateTable('clientsTable');

            // Update total clients count for this company
            document.getElementById('totalClients').innerText = companyClients.length;
        }

        function loadClientOptions() {
            const policyClientSelect = document.getElementById('policyClient');
            const claimPolicySelect = document.getElementById('claimPolicy');
            const claimClientNoInput = document.getElementById('modal-claim-client-no');

            if (policyClientSelect) {
                policyClientSelect.innerHTML = '<option value="">Select Client</option>';
                const companyClients = getCompanyClients();
                companyClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.text = client.name;
                    policyClientSelect.appendChild(option);
                });
            }

            if (claimPolicySelect) {
                claimPolicySelect.innerHTML = '<option value="">Select Policy</option>';
                const companyPolicies = getCompanyPolicies();
                companyPolicies.forEach(policy => {
                    const option = document.createElement('option');
                    option.value = policy.policyNumber;
                    const client = clients.find(c => c.id === policy.clientId);
                    option.text = `${policy.policyNumber} - ${client ? client.name : 'Unknown Client'}`;
                    claimPolicySelect.appendChild(option);
                });
            }

            if (claimClientNoInput) {
                claimClientNoInput.value = '';
            }
        }

        function editClient(clientId) {
            // Implement edit functionality
            const client = clients.find(c => c.id === clientId);
            if (client) {
                // Pre-fill the form
                document.getElementById('clientName').value = client.name;
                document.getElementById('clientEmail').value = client.email;
                document.getElementById('clientPhone').value = client.phone;
                document.getElementById('clientVAT').value = client.vatNumber;
                document.getElementById('clientVehicle').value = client.vehicleReg;
                document.getElementById('clientAddress').value = client.address;

                // Remove the client from the array
                clients = clients.filter(c => c.id !== clientId);
                localStorage.setItem('clients', JSON.stringify(clients));

                // Update the list and options
                loadClientList();
                loadClientOptions();

                // Navigate to Add Client section
                showSection('add-client');
            }
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client?')) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    clients = clients.filter(c => c.id !== clientId);
                    localStorage.setItem('clients', JSON.stringify(clients));

                    // Add to history
                    addToHistory('Deleted client', `Client Number: ${client.clientNumber}`);

                    // Update the list and options
                    loadClientList();
                    loadClientOptions();
                    document.getElementById('totalClients').innerText = getCompanyClients().length;
                }
            }
        }

        function viewClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                alert(`Client Details:\n\nName: ${client.name}\nEmail: ${client.email}\nPhone: ${client.phone}\nVAT Number: ${client.vatNumber || 'N/A'}\nVehicle Registration: ${client.vehicleReg || 'N/A'}\nAddress: ${client.address || 'N/A'}`);
            }
        }

        // Import Clients
        function importClients(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('No file selected.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const contents = e.target.result;
                parseCSV(contents);
            };
            reader.readAsText(file);
        }

        function parseCSV(data) {
            const lines = data.split('\n');
            const headers = lines[0].split(',');
            if (headers.length < 6) {
                alert('Invalid CSV format. Please ensure it has Name,Email,Phone,VAT Number,Vehicle Registration,Address columns.');
                return;
            }
            lines.slice(1).forEach(line => {
                const values = line.split(',');
                if (values.length >= 6) {
                    const client = {
                        id: Date.now() + Math.random(), // Use random to avoid duplicate IDs
                        name: values[0].trim(),
                        email: values[1].trim(),
                        phone: values[2].trim(),
                        vatNumber: values[3].trim(),
                        vehicleReg: values[4].trim(),
                        address: values[5].trim(),
                        company: getCurrentUser().company // Assign company from current user
                    };
                    clients.push(client);
                }
            });
            localStorage.setItem('clients', JSON.stringify(clients));
            loadClientList();
            loadClientOptions();
            alert('Clients imported successfully!');
        }

        function exportClients() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Name,Email,Phone,VAT Number,Vehicle Registration,Address\n";
            const companyClients = getCompanyClients();
            companyClients.forEach(client => {
                const row = `${client.name},${client.email},${client.phone},${client.vatNumber || 'N/A'},${client.vehicleReg || 'N/A'},${client.address || 'N/A'}`;
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "clients.csv");
            document.body.appendChild(link); // Required for FF

            link.click();
            document.body.removeChild(link);
        }

        // Policy Functions
        document.getElementById('createPolicyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const clientId = document.getElementById('policyClient').value;
            const type = document.getElementById('policyType').value.trim();
            const coverage = document.getElementById('coverageAmount').value;
            const premium = document.getElementById('premium').value;

            if (clientId === '' || type === '' || coverage === '' || premium === '') {
                alert('Please fill in all required fields.');
                return;
            }

            const policy = {
                policyNumber: 'POL' + Date.now(),
                clientId: clientId,
                type: type,
                coverage: parseFloat(coverage),
                premium: parseFloat(premium),
                status: 'Active',
                date: new Date().toISOString().split('T')[0] // Adding date field for reports
            };
            policies.push(policy);
            localStorage.setItem('policies', JSON.stringify(policies));

            // Add to history
            addToHistory('Created new policy', `Policy Number: ${policy.policyNumber}`);

            // Update active policies count
            document.getElementById('activePolicies').innerText = getCompanyPolicies().length;

            // Reset form
            document.getElementById('createPolicyForm').reset();

            alert('Policy created successfully!');
            loadPolicyOptions();
            loadPolicyList();
        });

        function loadPolicyList() {
            const tbody = document.getElementById('policiesTable').querySelector('tbody');
            tbody.innerHTML = '';
            const companyPolicies = getCompanyPolicies();

            companyPolicies.forEach(policy => {
                const client = clients.find(c => c.id === policy.clientId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${policy.policyNumber}</td>
                    <td>${client ? client.name : 'Unknown Client'}</td>
                    <td>${policy.type}</td>
                    <td>${policy.coverage}</td>
                    <td>${policy.premium}</td>
                    <td><span class="status-badge ${policy.status === 'Active' ? 'status-active' : 'status-closed'}">${policy.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewPolicy('${policy.policyNumber}')">View</button>
                        <button class="btn" onclick="editPolicy('${policy.policyNumber}')">Edit</button>
                        <button class="btn btn-danger" onclick="deletePolicy('${policy.policyNumber}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            // Initialize Pagination
            tablePageInfo['policiesTable'].currentPage = 1;
            paginateTable('policiesTable');
            // Update active policies count
            document.getElementById('activePolicies').innerText = companyPolicies.length;
        }

        function loadPolicyOptions() {
            const policyClientSelect = document.getElementById('policyClient');
            const claimPolicySelect = document.getElementById('claimPolicy');

            if (policyClientSelect) {
                policyClientSelect.innerHTML = '<option value="">Select Client</option>';
                const companyClients = getCompanyClients();
                companyClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.text = client.name;
                    policyClientSelect.appendChild(option);
                });
            }

            if (claimPolicySelect) {
                claimPolicySelect.innerHTML = '<option value="">Select Policy</option>';
                const companyPolicies = getCompanyPolicies();
                companyPolicies.forEach(policy => {
                    const option = document.createElement('option');
                    option.value = policy.policyNumber;
                    const client = clients.find(c => c.id === policy.clientId);
                    option.text = `${policy.policyNumber} - ${client ? client.name : 'Unknown Client'}`;
                    claimPolicySelect.appendChild(option);
                });
            }
        }

        function editPolicy(policyNumber) {
            // Implement edit functionality
            const policy = policies.find(p => p.policyNumber === policyNumber);
            if (policy) {
                // Pre-fill the form
                document.getElementById('policyClient').value = policy.clientId;
                document.getElementById('policyType').value = policy.type;
                document.getElementById('coverageAmount').value = policy.coverage;
                document.getElementById('premium').value = policy.premium;

                // Remove the policy from the array
                policies = policies.filter(p => p.policyNumber !== policyNumber);
                localStorage.setItem('policies', JSON.stringify(policies));

                // Update the list and options
                loadPolicyList();
                loadPolicyOptions();

                // Navigate to Create Policy section
                showSection('create-policy');
            }
        }

        function deletePolicy(policyNumber) {
            if (confirm('Are you sure you want to delete this policy?')) {
                const policy = policies.find(p => p.policyNumber === policyNumber);
                if (policy) {
                    policies = policies.filter(p => p.policyNumber !== policyNumber);
                    localStorage.setItem('policies', JSON.stringify(policies));

                    // Add to history
                    addToHistory('Deleted policy', `Policy Number: ${policy.policyNumber}`);

                    // Update the list and counts
                    loadPolicyList();
                    loadPolicyOptions();
                    document.getElementById('activePolicies').innerText = getCompanyPolicies().length;
                }
            }
        }

        function viewPolicy(policyNumber) {
            const policy = policies.find(p => p.policyNumber === policyNumber);
            const client = clients.find(c => c.id == policy.clientId);
            if (policy) {
                alert(`Policy Details:\n\nPolicy Number: ${policy.policyNumber}\nClient: ${client ? client.name : 'Unknown Client'}\nType: ${policy.type}\nCoverage: ${policy.coverage}\nPremium: ${policy.premium}\nStatus: ${policy.status}`);
            }
        }

        // Claim Functions
        document.getElementById('submitClaimForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const policyNumber = document.getElementById('claimPolicy').value;
            const dateOfIncident = document.getElementById('claimDate').value;
            const description = document.getElementById('claimDescription').value.trim();
            const documents = document.getElementById('claimDocuments').files;

            if (policyNumber === '' || dateOfIncident === '' || description === '') {
                alert('Please fill in all required fields.');
                return;
            }

            const claimNumber = generateClaimNumber();

            const claim = {
                claimNumber: claimNumber,
                policyNumber: policyNumber,
                dateOfIncident: dateOfIncident,
                description: description,
                status: 'Pending',
                documents: []
            };

            // Handle document uploads (simulate by storing filenames)
            for (let i = 0; i < documents.length; i++) {
                claim.documents.push(documents[i].name);
            }

            claims.push(claim);
            localStorage.setItem('claims', JSON.stringify(claims));

            // Add to history
            addToHistory('Submitted new claim', `Claim Number: ${claim.claimNumber}`);

            // Update pending claims count
            document.getElementById('pendingClaims').innerText = getCompanyPendingClaims().length;

            // Reset form
            document.getElementById('submitClaimForm').reset();

            alert('Claim submitted successfully!');
            loadClaimList();
            loadResolveClaimsList();
        });

        function generateClaimNumber() {
            return 'CLM' + Date.now();
        }

        function loadClaimList() {
            const tbody = document.getElementById('claimsTable').querySelector('tbody');
            tbody.innerHTML = '';

            const companyClaims = getCompanyClaims();

            companyClaims.forEach(claim => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${claim.claimNumber}</td>
                    <td>${claim.policyNumber}</td>
                    <td>${claim.dateOfIncident}</td>
                    <td>${claim.description}</td>
                    <td><span class="status-badge ${claim.status === 'Pending' ? 'status-pending' : claim.status === 'Approved' ? 'status-active' : 'status-closed'}">${claim.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewClaim('${claim.claimNumber}')">View</button>
                        <button class="btn" onclick="editClaim('${claim.claimNumber}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteClaim('${claim.claimNumber}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Initialize Pagination
            tablePageInfo['claimsTable'].currentPage = 1;
            paginateTable('claimsTable');
            // Update pending claims count
            updatePendingClaimsCount();
        }

        function loadResolveClaimsList() {
            const tbody = document.getElementById('resolveClaimsTable').querySelector('tbody');
            tbody.innerHTML = '';

            const companyPendingClaims = getCompanyPendingClaims();

            companyPendingClaims.forEach(claim => {
                const policy = policies.find(p => p.policyNumber == claim.policyNumber);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${claim.claimNumber}</td>
                    <td>${claim.policyNumber}</td>
                    <td>${claim.dateOfIncident}</td>
                    <td>${claim.description}</td>
                    <td><span class="status-badge status-pending">${claim.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="approveClaim('${claim.claimNumber}')">Approve</button>
                        <button class="btn btn-danger" onclick="rejectClaim('${claim.claimNumber}')">Reject</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePendingClaimsCount() {
            const pendingCount = getCompanyPendingClaims().length;
            document.getElementById('pendingClaims').innerText = pendingCount;
        }

        function editClaim(claimNumber) {
            // Implement edit functionality
            const claim = claims.find(c => c.claimNumber === claimNumber);
            if (claim) {
                // Pre-fill the form
                document.getElementById('claimPolicy').value = claim.policyNumber;
                document.getElementById('claimDate').value = claim.dateOfIncident;
                document.getElementById('claimDescription').value = claim.description;

                // Remove the claim from the array
                claims = claims.filter(c => c.claimNumber !== claimNumber);
                localStorage.setItem('claims', JSON.stringify(claims));

                // Update the list
                loadClaimList();

                // Navigate to Submit Claim section
                showSection('submit-claim');
            }
        }

        function deleteClaim(claimNumber) {
            if (confirm('Are you sure you want to delete this claim?')) {
                const claim = claims.find(c => c.claimNumber === claimNumber);
                if (claim) {
                    claims = claims.filter(c => c.claimNumber !== claimNumber);
                    localStorage.setItem('claims', JSON.stringify(claims));

                    // Add to history
                    addToHistory('Deleted claim', `Claim Number: ${claim.claimNumber}`);

                    // Update the list and counts
                    loadClaimList();
                    loadResolveClaimsList();
                    updatePendingClaimsCount();
                }
            }
        }

        function viewClaim(claimNumber) {
            const claim = claims.find(c => c.claimNumber === claimNumber);
            const policy = policies.find(p => p.policyNumber == claim.policyNumber);
            if (claim) {
                alert(`Claim Details:\n\nClaim Number: ${claim.claimNumber}\nPolicy Number: ${claim.policyNumber}\nDate of Incident: ${claim.dateOfIncident}\nDescription: ${claim.description}\nStatus: ${claim.status}`);
            }
        }

        function approveClaim(claimNumber) {
            const claim = claims.find(c => c.claimNumber === claimNumber);
            if (claim) {
                const paymentAmount = prompt('Enter payment amount for this claim:', '0.00');
                if (paymentAmount === null || paymentAmount.trim() === '' || isNaN(paymentAmount)) {
                    alert('Invalid payment amount.');
                    return;
                }
                claim.status = 'Approved';
                claim.paymentAmount = parseFloat(paymentAmount).toFixed(2);
                localStorage.setItem('claims', JSON.stringify(claims));

                // Add to history
                addToHistory('Approved claim payment', `Claim Number: ${claim.claimNumber}, Amount: $${claim.paymentAmount}`);

                // Update UI
                loadClaimList();
                loadResolveClaimsList();
                updatePendingClaimsCount();

                alert('Claim approved and payment processed.');
            }
        }

        function rejectClaim(claimNumber) {
            const claim = claims.find(c => c.claimNumber === claimNumber);
            if (claim) {
                claim.status = 'Rejected';
                localStorage.setItem('claims', JSON.stringify(claims));

                // Add to history
                addToHistory('Rejected claim', `Claim Number: ${claim.claimNumber}`);

                // Update UI
                loadClaimList();
                loadResolveClaimsList();
                updatePendingClaimsCount();

                alert('Claim has been rejected.');
            }
        }

        // Search Functionality
        let currentSearchFilter = 'clientName'; // Default filter

        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentSearchFilter = this.innerText.toLowerCase().replace(' ', '');
            });
        });

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (searchTerm === '') {
                alert('Please enter a search term.');
                return;
            }

            let results = [];

            switch(currentSearchFilter) {
                case 'clientname':
                    results = getCompanyClients().filter(client =>
                        client.name.toLowerCase().includes(searchTerm) ||
                        client.email.toLowerCase().includes(searchTerm) ||
                        client.phone.toLowerCase().includes(searchTerm) ||
                        client.vatNumber.toLowerCase().includes(searchTerm) ||
                        client.vehicleReg.toLowerCase().includes(searchTerm)
                    );
                    break;
                case 'clientnumber':
                    results = getCompanyClients().filter(client =>
                        client.clientNumber.toLowerCase().includes(searchTerm)
                    );
                    break;
                case 'policynumber':
                    results = getCompanyPolicies().filter(policy =>
                        policy.policyNumber.toLowerCase().includes(searchTerm)
                    );
                    break;
                case 'idnumber':
                    results = getCompanyClients().filter(client =>
                        client.idNumber && client.idNumber.toLowerCase().includes(searchTerm)
                    );
                    break;
                case 'claimnumber':
                    results = getCompanyClaims().filter(claim =>
                        claim.claimNumber.toLowerCase().includes(searchTerm)
                    );
                    break;
                case 'alternatepolicynumber':
                    // Implement if there's an alternate policy number field
                    results = [];
                    break;
                case 'alternateclaimnumber':
                    // Implement if there's an alternate claim number field
                    results = [];
                    break;
                case 'vehicleregno':
                    results = getCompanyClients().filter(client =>
                        client.vehicleReg && client.vehicleReg.toLowerCase().includes(searchTerm)
                    );
                    break;
                default:
                    results = [];
            }

            const searchResultsDiv = document.getElementById('searchResults');
            searchResultsDiv.innerHTML = '';

            if (results.length > 0) {
                const table = document.createElement('table');
                table.className = 'clients-table';
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>VAT Number</th>
                        <th>Vehicle Reg.</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                `;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                results.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>${client.email}</td>
                        <td>${client.phone}</td>
                        <td>${client.vatNumber || 'N/A'}</td>
                        <td>${client.vehicleReg || 'N/A'}</td>
                        <td>${client.address || 'N/A'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewClient(${client.id})">View</button>
                            <button class="btn" onclick="editClient(${client.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteClient(${client.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                searchResultsDiv.appendChild(table);
            } else {
                searchResultsDiv.innerHTML = '<p>No results found.</p>';
            }

            // Add to recent activities
            addToHistory('Performed search', `Search term: "${searchTerm}" with filter: "${currentSearchFilter}"`);
        }

        // Policy Search Functionality
        function searchPolicies() {
            const searchTerm = document.getElementById('policySearch').value.toLowerCase();
            const companyPolicies = getCompanyPolicies();
            const results = companyPolicies.filter(policy =>
                policy.policyNumber.toLowerCase().includes(searchTerm) ||
                (clients.find(c => c.id == policy.clientId && c.name.toLowerCase().includes(searchTerm)))
            ).map(policy => {
                const client = clients.find(c => c.id === policy.clientId);
                return {
                    policyNumber: policy.policyNumber,
                    clientName: client ? client.name : 'Unknown Client',
                    type: policy.type,
                    coverage: policy.coverage,
                    premium: policy.premium,
                    status: policy.status
                };
            });

            const policyResultsDiv = document.getElementById('policyResults');
            policyResultsDiv.innerHTML = '';

            if (results.length > 0) {
                const table = document.createElement('table');
                table.className = 'clients-table';
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Policy Number</th>
                        <th>Client Name</th>
                        <th>Type</th>
                        <th>Coverage</th>
                        <th>Premium</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                `;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                results.forEach(policy => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${policy.policyNumber}</td>
                        <td>${policy.clientName}</td>
                        <td>${policy.type}</td>
                        <td>${policy.coverage}</td>
                        <td>${policy.premium}</td>
                        <td><span class="status-badge ${policy.status === 'Active' ? 'status-active' : 'status-closed'}">${policy.status}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewPolicy('${policy.policyNumber}')">View</button>
                            <button class="btn" onclick="editPolicy('${policy.policyNumber}')">Edit</button>
                            <button class="btn btn-danger" onclick="deletePolicy('${policy.policyNumber}')">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                policyResultsDiv.appendChild(table);
            } else {
                policyResultsDiv.innerHTML = '<p>No results found.</p>';
            }

            // Add to recent activities
            addToHistory('Performed policy search', `Search term: "${searchTerm}"`);
        }

        // History Functions
        function addToHistory(action, details) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            const entry = {
                date: new Date().toLocaleString(),
                action: action,
                details: details,
                company: currentUser.company
            };
            history.unshift(entry);
            localStorage.setItem('history', JSON.stringify(history));
            loadRecentActivities();
        }

        function loadRecentActivities() {
            const recentActivitiesList = document.getElementById('recentActivities');
            recentActivitiesList.innerHTML = '';
            const recent = history.filter(entry => entry.company === getCurrentUser().company).slice(0, 5);
            recent.forEach(entry => {
                const listItem = document.createElement('li');
                listItem.textContent = `${entry.date}: ${entry.action} - ${entry.details}`;
                recentActivitiesList.appendChild(listItem);
            });
        }

        // Generate Unique Client Number
        function generateClientNumber() {
            let clientNo;
            do {
                const uniqueNumber = Math.floor(10000 + Math.random() * 90000); // 5-digit number
                clientNo = 'PFC' + uniqueNumber;
            } while(clients.some(client => client.clientNumber === clientNo));
            return clientNo;
        }

        // Generate Unique Claim Number
        function generateClaimNumber() {
            return 'CLM' + Date.now();
        }

        // Export and Import are handled above

        // Approve and Reject Claims (Handled in resolve claims section)

        // Report Generation Functions
        document.getElementById('runReportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!reportType || !startDate || !endDate) {
                alert('Please fill in all required fields.');
                return;
            }

            // Generate report based on type and date range
            switch(reportType) {
                case 'lossRatio':
                    generateLossRatioReport(startDate, endDate);
                    break;
                case 'policySummary':
                    generatePolicySummaryReport(startDate, endDate);
                    break;
                // Add more cases as needed
                default:
                    alert('Invalid report type.');
            }
        });

        function generateLossRatioReport(startDate, endDate) {
            // Logic to calculate loss ratio and display it
            const policiesInRange = getCompanyPolicies().filter(policy => {
                // Assuming policies have a 'date' field
                const policyDate = new Date(policy.date);
                return policyDate >= new Date(startDate) && policyDate <= new Date(endDate);
            });

            const totalPremium = policiesInRange.reduce((sum, policy) => sum + policy.premium, 0);
            const totalClaims = getCompanyClaims().reduce((sum, claim) => {
                const relatedPolicy = policies.find(p => p.policyNumber === claim.policyNumber);
                if (relatedPolicy && new Date(relatedPolicy.date) >= new Date(startDate) && new Date(relatedPolicy.date) <= new Date(endDate)) {
                    return sum + (claim.paymentAmount ? parseFloat(claim.paymentAmount) : 0);
                }
                return sum;
            }, 0); // Assuming claim.paymentAmount exists

            const lossRatio = totalPremium > 0 ? (totalClaims / totalPremium) * 100 : 0;

            document.getElementById('reportResults').innerHTML = `
                <h3>Loss Ratio from ${startDate} to ${endDate}</h3>
                <p>Total Premium: $${totalPremium.toFixed(2)}</p>
                <p>Total Claims: $${totalClaims.toFixed(2)}</p>
                <p>Loss Ratio: ${lossRatio.toFixed(2)}%</p>
            `;

            // Add to history
            addToHistory('Generated loss ratio report', `From ${startDate} to ${endDate}`);
        }

        function generatePolicySummaryReport(startDate, endDate) {
            // Logic to generate policy summary
            const policiesInRange = getCompanyPolicies().filter(policy => {
                const policyDate = new Date(policy.date);
                return policyDate >= new Date(startDate) && policyDate <= new Date(endDate);
            });

            let summary = `<h3>Policy Summary from ${startDate} to ${endDate}</h3><table class="clients-table"><thead><tr><th>Policy No.</th><th>Client Name</th><th>Type</th><th>Coverage</th><th>Premium</th><th>Status</th></tr></thead><tbody>`;

            policiesInRange.forEach(policy => {
                const client = clients.find(c => c.id === policy.clientId);
                summary += `
                    <tr>
                        <td>${policy.policyNumber}</td>
                        <td>${client ? client.name : 'Unknown Client'}</td>
                        <td>${policy.type}</td>
                        <td>${policy.coverage}</td>
                        <td>${policy.premium}</td>
                        <td><span class="status-badge ${policy.status === 'Active' ? 'status-active' : 'status-closed'}">${policy.status}</span></td>
                    </tr>
                `;
            });

            summary += `</tbody></table>`;

            document.getElementById('reportResults').innerHTML = summary;

            // Add to history
            addToHistory('Generated policy summary report', `From ${startDate} to ${endDate}`);
        }

        // Loss Ratio Analysis Functionality
        function renderLossRatioChart() {
            const ctx = document.getElementById('loss-ratio-chart').getContext('2d');
            const labels = getCompanyClients().map(client => client.name);
            const lossRatios = getCompanyClients().map(client => parseFloat(client.lossRatio));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Loss Ratio (%)',
                        data: lossRatios,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Loss Ratio (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Clients'
                            }
                        }
                    }
                }
            });
        }

        // Financial Reports Chart
        function renderFinancialChart() {
            const ctx = document.getElementById('financialChart').getContext('2d');
            // Sample data, replace with actual financial data
            const labels = ['January', 'February', 'March', 'April', 'May', 'June'];
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Revenue',
                    data: [5000, 7000, 8000, 6000, 9000, 10000],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Expenses',
                    data: [4000, 5000, 6000, 4500, 7000, 8000],
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            };
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                },
            };
            new Chart(ctx, config);
        }

        // Report Generation for Manager Reports
        document.getElementById('manager-reports-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const reportType = document.getElementById('manager-report-type').value;

            if (reportType === '') {
                alert('Please select a report type.');
                return;
            }

            let reportContent = '';
            let reportTitle = '';

            switch(reportType) {
                case 'agentPerformance':
                    reportTitle = 'Agent Performance Report';
                    reportContent = generateAgentPerformanceReport();
                    break;
                case 'policyGrowth':
                    reportTitle = 'Policy Growth Report';
                    reportContent = generatePolicyGrowthReport();
                    break;
                // Add more cases for additional manager-specific report types
                default:
                    reportTitle = 'Unknown Report';
                    reportContent = '<p>Report generation not implemented.</p>';
            }

            // Display manager report
            document.getElementById('manager-report-title').innerText = reportTitle;
            document.getElementById('manager-report-content').innerHTML = reportContent;
            document.getElementById('manager-report-display').style.display = 'block';

            // Add to history
            addToHistory('Generated manager report', `Report Type: ${reportType}`);
        });

        // Sample Manager Report Generation Functions
        function generateAgentPerformanceReport() {
            // Placeholder for agent performance data
            return `
                <p>Agent Performance Report is currently under development.</p>
            `;
        }

        function generatePolicyGrowthReport() {
            // Placeholder for policy growth data
            return `
                <p>Policy Growth Report is currently under development.</p>
            `;
        }

        // Render Client Info in Header
        function loadClientInfo() {
            // Assuming we display info of the first client or selected client
            if (clients.length > 0) {
                const client = getCompanyClients()[0];
                if (client) {
                    displayClientInfo(client);
                }
            }
        }

        function displayClientInfo(client) {
            const clientInfoTbody = document.getElementById('clientInfo');
            const policyClaimInfoTbody = document.getElementById('policyClaimInfo');

            clientInfoTbody.innerHTML = `
                <tr>
                    <td>${client.clientNumber}</td>
                    <td>${client.name}</td>
                    <td>${client.commission || 'N/A'}</td>
                </tr>
            `;

            // Find associated policy and claim
            const policy = policies.find(p => p.clientId === client.id);
            const claim = claims.find(c => c.policyNumber === (policy ? policy.policyNumber : 'N/A'));

            policyClaimInfoTbody.innerHTML = `
                <tr>
                    <td>${policy ? policy.policyNumber : 'N/A'}</td>
                    <td>${claim ? claim.claimNumber : 'N/A'}</td>
                    <td>${policy ? policy.type : 'N/A'}</td>
                    <td>${policy ? policy.status : 'N/A'}</td>
                    <td>${client.lossRatio || 'N/A'}</td>
                </tr>
            `;
        }

        // Reports and Claims Management placeholders can be further developed as needed

        // Render Manager Reports List (Placeholder)
        function loadReports() {
            loadMonthEndHistory();
            loadManagerReports();
        }

        function loadMonthEndHistory() {
            const historyBody = document.getElementById('month-end-history-body');
            historyBody.innerHTML = '';

            if(monthEndReports.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="4" class="text-center">No month-end reports generated.</td></tr>';
                return;
            }

            monthEndReports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.reportId}</td>
                    <td>${report.reportType}</td>
                    <td>${report.dateGenerated}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewMonthEndReport('${report.reportId}')">View</button>
                        <button class="btn btn-secondary" onclick="downloadMonthEndReport('${report.reportId}')">Download</button>
                    </td>
                `;
                historyBody.appendChild(row);
            });
        }

        function loadManagerReports() {
            // Implement if needed
        }

        function viewMonthEndReport(reportId) {
            const report = monthEndReports.find(r => r.reportId === reportId);
            if(!report) {
                alert('Report not found.');
                return;
            }

            // Display report details
            const reportContent = `
                <h4>${report.reportType}</h4>
                <p>Date Generated: ${report.dateGenerated}</p>
                <pre>${report.content}</pre>
            `;
            alert(reportContent);
        }

        function downloadMonthEndReport(reportId) {
            const report = monthEndReports.find(r => r.reportId === reportId);
            if(!report) {
                alert('Report not found.');
                return;
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 2));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", `${report.reportType.replace(/\s+/g, '_')}_${report.reportId}.json`);
            document.body.appendChild(link); // Required for FF

            link.click();
            document.body.removeChild(link);
        }

        // Report Generation Functions for Financial Reports and Manager Reports
        // ...already implemented above...

        // Render Charts and Other Dynamic Content
        // ...already implemented above...

        // Initialize Button Handlers
        function initializeButtonHandlers() {
            // Sidebar menu items
            document.querySelectorAll('.sidebar .menu-item[data-section]').forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
        }

        // Helper function to paginate tables
        function paginateTable(tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.tBodies[0];
            const pageInfo = tablePageInfo[tableId];
            const totalRows = getTotalRows(tableId);
            const totalPages = Math.ceil(totalRows / pageInfo.rowsPerPage);

            // Clear existing rows
            tbody.innerHTML = '';

            // Get rows for current page
            const start = (pageInfo.currentPage - 1) * pageInfo.rowsPerPage;
            const end = start + pageInfo.rowsPerPage;
            const paginatedRows = getAllRows(tableId).slice(start, end);

            // Append sorted rows
            paginatedRows.forEach(row => tbody.appendChild(row));

            // Update page info display
            if (tableId === 'policiesTable') {
                const pageInfoElement = document.getElementById('policiesPageInfo');
                if (pageInfoElement) {
                    pageInfoElement.innerText = `Page ${pageInfo.currentPage} of ${totalPages}`;
                }
            } else if (tableId === 'claimsTable') {
                const pageInfoElement = document.getElementById('claimsPageInfo');
                if (pageInfoElement) {
                    pageInfoElement.innerText = `Page ${pageInfo.currentPage} of ${totalPages}`;
                }
            } else if (tableId === 'clientsTable') {
                const pageInfoElement = document.getElementById('clientsPageInfo');
                if (pageInfoElement) {
                    pageInfoElement.innerText = `Page ${pageInfo.currentPage} of ${totalPages}`;
                }
            }
        }

        function prevPage(tableId) {
            const pageInfo = tablePageInfo[tableId];
            if (pageInfo.currentPage > 1) {
                pageInfo.currentPage--;
                paginateTable(tableId);
            }
        }

        function nextPage(tableId) {
            const pageInfo = tablePageInfo[tableId];
            const totalRows = getTotalRows(tableId);
            const totalPages = Math.ceil(totalRows / pageInfo.rowsPerPage);
            if (pageInfo.currentPage < totalPages) {
                pageInfo.currentPage++;
                paginateTable(tableId);
            }
        }

        function getTotalRows(tableId) {
            if (tableId === 'clientsTable') {
                return getCompanyClients().length;
            } else if (tableId === 'policiesTable') {
                return getCompanyPolicies().length;
            } else if (tableId === 'claimsTable') {
                return getCompanyClaims().length;
            } else {
                return 0;
            }
        }

        function getAllRows(tableId) {
            let data = [];
            if (tableId === 'clientsTable') {
                data = getCompanyClients().map(client => {
                    return {
                        name: client.name,
                        email: client.email,
                        phone: client.phone,
                        vatNumber: client.vatNumber || 'N/A',
                        vehicleReg: client.vehicleReg || 'N/A',
                        address: client.address || 'N/A',
                        id: client.id
                    };
                });
            } else if (tableId === 'policiesTable') {
                data = getCompanyPolicies().map(policy => {
                    const client = clients.find(c => c.id === policy.clientId);
                    return {
                        policyNumber: policy.policyNumber,
                        clientName: client ? client.name : 'Unknown Client',
                        type: policy.type,
                        coverage: policy.coverage,
                        premium: policy.premium,
                        status: policy.status
                    };
                });
            } else if (tableId === 'claimsTable') {
                data = getCompanyClaims().map(claim => {
                    return {
                        claimNumber: claim.claimNumber,
                        policyNumber: claim.policyNumber,
                        dateOfIncident: claim.dateOfIncident,
                        description: claim.description,
                        status: claim.status
                    };
                });
            }

            // Create rows
            const rows = data.map(item => {
                const row = document.createElement('tr');
                if (tableId === 'clientsTable') {
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.email}</td>
                        <td>${item.phone}</td>
                        <td>${item.vatNumber}</td>
                        <td>${item.vehicleReg}</td>
                        <td>${item.address}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewClient(${item.id})">View</button>
                            <button class="btn" onclick="editClient(${item.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteClient(${item.id})">Delete</button>
                        </td>
                    `;
                } else if (tableId === 'policiesTable') {
                    row.innerHTML = `
                        <td>${item.policyNumber}</td>
                        <td>${item.clientName}</td>
                        <td>${item.type}</td>
                        <td>${item.coverage}</td>
                        <td>${item.premium}</td>
                        <td><span class="status-badge ${item.status === 'Active' ? 'status-active' : 'status-closed'}">${item.status}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewPolicy('${item.policyNumber}')">View</button>
                            <button class="btn" onclick="editPolicy('${item.policyNumber}')">Edit</button>
                            <button class="btn btn-danger" onclick="deletePolicy('${item.policyNumber}')">Delete</button>
                        </td>
                    `;
                } else if (tableId === 'claimsTable') {
                    row.innerHTML = `
                        <td>${item.claimNumber}</td>
                        <td>${item.policyNumber}</td>
                        <td>${item.dateOfIncident}</td>
                        <td>${item.description}</td>
                        <td><span class="status-badge ${item.status === 'Pending' ? 'status-pending' : item.status === 'Approved' ? 'status-active' : 'status-closed'}">${item.status}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewClaim('${item.claimNumber}')">View</button>
                            <button class="btn" onclick="editClaim('${item.claimNumber}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteClaim('${item.claimNumber}')">Delete</button>
                        </td>
                    `;
                }
                return row;
            });

            return rows;
        }

        // Client Info in Header
        function loadClientInfo() {
            // Assuming we display info of the first client or selected client
            if (clients.length > 0) {
                const client = getCompanyClients()[0];
                if (client) {
                    displayClientInfo(client);
                }
            }
        }

        // Display Client Info in Header
        function displayClientInfo(client) {
            const clientInfoTbody = document.getElementById('clientInfo');
            const policyClaimInfoTbody = document.getElementById('policyClaimInfo');

            clientInfoTbody.innerHTML = `
                <tr>
                    <td>${client.clientNumber}</td>
                    <td>${client.name}</td>
                    <td>${client.commission || 'N/A'}</td>
                </tr>
            `;

            // Find associated policy and claim
            const policy = policies.find(p => p.clientId === client.id);
            const claim = claims.find(c => c.policyNumber === (policy ? policy.policyNumber : 'N/A'));

            policyClaimInfoTbody.innerHTML = `
                <tr>
                    <td>${policy ? policy.policyNumber : 'N/A'}</td>
                    <td>${claim ? claim.claimNumber : 'N/A'}</td>
                    <td>${policy ? policy.type : 'N/A'}</td>
                    <td>${policy ? policy.status : 'N/A'}</td>
                    <td>${client.lossRatio || 'N/A'}</td>
                </tr>
            `;
        }

        // Data Saving Function
        function saveData() {
            localStorage.setItem('clients', JSON.stringify(clients));
            localStorage.setItem('policies', JSON.stringify(policies));
            localStorage.setItem('claims', JSON.stringify(claims));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('history', JSON.stringify(history));
            localStorage.setItem('refunds', JSON.stringify(refunds));
            localStorage.setItem('payments', JSON.stringify(payments));
            localStorage.setItem('recentActivities', JSON.stringify(recentActivities));
            localStorage.setItem('monthEndReports', JSON.stringify(monthEndReports));
            localStorage.setItem('managerReports', JSON.stringify(managerReports));
        }

        // Add to history function
        function addToHistory(action, details) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            const entry = {
                date: new Date().toLocaleString(),
                action: action,
                details: details,
                company: currentUser.company
            };
            history.unshift(entry);
            localStorage.setItem('history', JSON.stringify(history));
            loadRecentActivities();
        }

        // Sorting Functionality
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            const th = table.tHead.rows[0].cells[columnIndex];
            const isAscending = th.classList.contains('sort-asc');
            const isDescending = th.classList.contains('sort-desc');

            // Remove sorting classes from all headers
            table.querySelectorAll('th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // Determine sort order
            let sortOrder = 'asc';
            if (isAscending) {
                sortOrder = 'desc';
            }

            // Add sort class to the current header
            th.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');

            // Get rows
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);

            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();

                // Check if numeric
                const aNum = parseFloat(aText.replace(/[^0-9.-]+/g,""));
                const bNum = parseFloat(bText.replace(/[^0-9.-]+/g,""));
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return sortOrder === 'asc' ? aNum - bNum : bNum - aNum;
                } else {
                    return sortOrder === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
                }
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));

            // Initialize Pagination
            tablePageInfo[tableId].currentPage = 1;
            paginateTable(tableId);
        }

        // Pagination Controls
        function createPaginationControls(tableId) {
            const table = document.getElementById(tableId);
            const paginationDiv = document.createElement('div');
            paginationDiv.classList.add('pagination');

            const prevBtn = document.createElement('button');
            prevBtn.classList.add('btn');
            prevBtn.innerText = 'Previous';
            prevBtn.onclick = () => prevPage(tableId);

            const pageInfo = document.createElement('span');
            pageInfo.id = `${tableId}PageInfo`;
            pageInfo.innerText = 'Page 1 of 1';

            const nextBtn = document.createElement('button');
            nextBtn.classList.add('btn');
            nextBtn.innerText = 'Next';
            nextBtn.onclick = () => nextPage(tableId);

            paginationDiv.appendChild(prevBtn);
            paginationDiv.appendChild(pageInfo);
            paginationDiv.appendChild(nextBtn);

            table.parentNode.insertBefore(paginationDiv, table.nextSibling);
        }

        // Generate Reports
        function loadReports() {
            loadMonthEndHistory();
            loadManagerReports();
        }

        // Manager Reports List
        function loadManagerReports() {
            // Implement manager reports list if needed
        }

        // Additional functionalities can be implemented similarly

        // Save Data on Unload
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html> 
