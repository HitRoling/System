<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Styles */
        body {
            overflow: hidden;
        }
        #sidebar {
            min-width: 250px;
            max-width: 250px;
            background: #002F6C;
            color: #fff;
            transition: all 0.3s;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }
        #sidebar .sidebar-header {
            padding: 20px;
            background: #001F4D;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            border-bottom: 1px solid #003F8C;
        }
        #sidebar ul.components {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        #sidebar ul li {
            padding: 10px;
            padding-left: 20px;
            font-size: 1em;
            display: block;
        }
        #sidebar ul li a {
            color: #fff;
            display: block;
            text-decoration: none;
            transition: 0.3s;
        }
        #sidebar ul li a:hover {
            background: #4A90E2;
            color: #fff;
        }
        #sidebar ul li.active > a {
            background: #4A90E2;
            color: #fff;
        }
        #sidebar ul li a i {
            margin-right: 10px;
        }
        #content {
            width: calc(100% - 250px);
            margin-left: 250px;
            transition: all 0.3s;
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
        }
        @media (max-width: 768px) {
            #sidebar {
                margin-left: -250px;
            }
            #sidebar.active {
                margin-left: 0;
            }
            #content {
                width: 100%;
                margin: 0;
            }
            #content.active {
                width: calc(100% - 250px);
                margin-left: 250px;
            }
        }
        #info-bar {
            background: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #ccc;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: none;
            justify-content: flex-start;
            align-items: center;
        }
        .info-field {
            margin-right: 30px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        .logout-btn {
            margin-left: auto;
            margin-right: 20px;
        }
        .summary-box {
            background: #4A4A4A;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s, transform 0.3s;
        }
        .summary-box:hover {
            background: #5A5A5A;
            transform: translateY(-5px);
        }
        .summary-box .info {
            text-align: left;
        }
        .summary-box .info .number {
            font-size: 2em;
            font-weight: bold;
        }
        .summary-box .info .label {
            font-size: 1em;
        }
        .summary-box .icon {
            font-size: 2em;
            opacity: 0.7;
        }
        #recent-activities {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        #recent-activities h2 {
            margin-bottom: 15px;
            color: #333;
        }
        .activity-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .activity-item i {
            margin-right: 10px;
            color: #007BFF;
        }
        .modal-header {
            background-color: #002F6C;
            color: #fff;
        }
        #clients-list-table th, #clients-list-table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <script>
        (function () {
            try {
                console.log('Checking authentication...');
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser || !currentUser.company) {
                    console.log('No user or company found. Redirecting to login.html.');
                    window.location.href = 'login.html';
                    return;
                }
                console.log('Logged in as:', currentUser.username, 'Company:', currentUser.company);
            } catch (error) {
                console.error('Error during authentication check:', error);
                window.location.href = 'login.html';
            }
        })();
    </script>

    <nav id="sidebar">
        <div class="sidebar-header">
            Insurance System
            <div id="company-name" style="font-size: 0.8em; margin-top: 5px;"></div>
        </div>
        <ul class="components">
            <li class="active">
                <a href="#" data-target="dashboard" class="menu-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </li>
            <li>
                <a href="#clientSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-user"></i>
                    Client Management
                </a>
                <ul class="collapse list-unstyled" id="clientSubmenu">
                    <li>
                        <a href="#" data-target="clientsList" class="menu-link">Clients List</a>
                    </li>
                    <li>
                        <a href="#" data-target="clientSearch" class="menu-link">Client Search</a>
                    </li>
                    <li>
                        <a href="#" data-target="complaints" class="menu-link">Complaints</a>
                    </li>
                    <li>
                        <a href="#" id="export-clients-btn" class="menu-link">Export Clients</a>
                    </li>
                    <li>
                        <a href="#" id="import-clients-btn" class="menu-link">Import Clients</a>
                        <input type="file" id="import-clients-input" accept=".json" style="display: none;">
                    </li>
                </ul>
            </li>
            <li>
                <a href="#policySubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Policy Accounts
                </a>
                <ul class="collapse list-unstyled" id="policySubmenu">
                    <li>
                        <a href="#" data-target="viewAccount" class="menu-link">View Account</a>
                    </li>
                    <li>
                        <a href="#" data-target="refunds" class="menu-link">Refunds</a>
                    </li>
                    <li>
                        <a href="#" data-target="journal" class="menu-link">Journal</a>
                    </li>
                    <li>
                        <a href="#" data-target="unmetCancellation" class="menu-link">Unmet Cancellation</a>
                    </li>
                    <li>
                        <a href="#" data-target="history" class="menu-link">History</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#claimsSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-clipboard-list"></i>
                    Claims Management
                </a>
                <ul class="collapse list-unstyled" id="claimsSubmenu">
                    <li>
                        <a href="#" data-target="currentClaims" class="menu-link">Current Claims</a>
                    </li>
                    <li>
                        <a href="#" data-target="claimsDetails" class="menu-link">Claims Details</a>
                    </li>
                    <li>
                        <a href="#" data-target="claimsEndorsements" class="menu-link">Claims Endorsements</a>
                    </li>
                    <li>
                        <a href="#" data-target="claimsPayment" class="menu-link">Claims Payment</a>
                    </li>
                    <li>
                        <a href="#" data-target="claimsParties" class="menu-link">Claims Parties</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#reportsSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-chart-line"></i>
                    Reports
                </a>
                <ul class="collapse list-unstyled" id="reportsSubmenu">
                    <li>
                        <a href="#" data-target="runReport" class="menu-link">Run Report</a>
                    </li>
                    <li>
                        <a href="#" data-target="lossRatio" class="menu-link">Loss Ratio Analysis</a>
                    </li>
                    <li>
                        <a href="#" data-target="monthEndHistory" class="menu-link">Month-End Report History</a>
                    </li>
                    <li>
                        <a href="#" data-target="managerReports" class="menu-link">Manager Reports</a>
                    </li>
                </ul>
            </li>
        </ul>
    </nav>

    <div id="content">
        <!-- Header (Info Bar) -->
        <header id="info-bar" class="d-flex flex-wrap">
            <div class="info-field">Client No.: <span id="client-no"></span></div>
            <div class="info-field">Client Name: <span id="client-name"></span></div>
            <div class="info-field">Commission: <span id="commission"></span></div>
            <div class="info-field">Policy No.: <span id="policy-no"></span></div>
            <div class="info-field">Claim No.: <span id="claim-no"></span></div>
            <div class="info-field">Product Info: <span id="product-info"></span></div>
            <div class="info-field">Status: <span id="status"></span></div>
            <div class="info-field">Loss Ratio: <span id="loss-ratio"></span></div>
            <button class="btn btn-danger logout-btn" id="logout-btn">Logout</button>
        </header>

        <!-- Main Sections -->
        <div id="main-sections">
            <!-- Dashboard -->
            <section id="dashboard-section" class="mt-4">
                <h2>Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3 mb-3">
                        <div class="summary-box" data-target="totalClients">
                            <div class="info">
                                <div class="number" id="total-clients">0</div>
                                <div class="label">Total Clients</div>
                            </div>
                            <div class="icon"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-box" data-target="activePolicies">
                            <div class="info">
                                <div class="number" id="active-policies">0</div>
                                <div class="label">Active Policies</div>
                            </div>
                            <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-box" data-target="pendingClaims">
                            <div class="info">
                                <div class="number" id="pending-claims">0</div>
                                <div class="label">Pending Claims</div>
                            </div>
                            <div class="icon"><i class="fas fa-clipboard-list"></i></div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="summary-box" data-target="notifications">
                            <div class="info">
                                <div class="number" id="notifications">0</div>
                                <div class="label">Notifications</div>
                            </div>
                            <div class="icon"><i class="fas fa-bell"></i></div>
                        </div>
                    </div>
                </div>
                <div class="mt-5">
                    <h3>Recent Activities</h3>
                    <div id="recent-activities" class="mt-3">
                        <!-- Dynamic Activities -->
                    </div>
                </div>
            </section>

            <!-- Clients List Section -->
            <section id="clientsList-section" class="mt-4 d-none">
                <h2>Clients List</h2>
                <div class="mb-3">
                    <button class="btn btn-success" id="add-client-btn">Add New Client</button>
                </div>
                <table class="table table-striped" id="clients-list-table">
                    <thead>
                        <tr>
                            <th>Item No.</th>
                            <th>Client No.</th>
                            <th>Client Name</th>
                            <th>Policy No.</th>
                            <th>Claim No.</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clients-list-body">
                        <!-- Dynamic Clients -->
                    </tbody>
                </table>
            </section>

            <!-- Client Search Section -->
            <section id="clientSearch-section" class="mt-4 d-none">
                <h2>Client Search</h2>
                <form id="client-search-form" class="mt-4">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="search-client-name" class="form-label">Client Name</label>
                            <input type="text" class="form-control" id="search-client-name" placeholder="Enter client name">
                        </div>
                        <div class="col-md-4">
                            <label for="search-client-number" class="form-label">Client Number</label>
                            <input type="text" class="form-control" id="search-client-number" placeholder="Enter client number">
                        </div>
                        <div class="col-md-4">
                            <label for="search-policy-number" class="form-label">Policy Number</label>
                            <input type="text" class="form-control" id="search-policy-number" placeholder="Enter policy number">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Search</button>
                </form>

                <!-- Search Results -->
                <div id="search-results" class="mt-4 d-none">
                    <h3>Search Results</h3>
                    <table class="table table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Item No.</th>
                                <th>Client No.</th>
                                <th>Client Name</th>
                                <th>Policy No.</th>
                                <th>Claim No.</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="search-results-body">
                            <!-- Dynamic Rows -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Complaints Section -->
            <section id="complaints-section" class="mt-4 d-none">
                <h2>Complaints Management</h2>
                <form id="complaint-form" class="mt-4">
                    <div class="mb-3">
                        <label for="complaint-client-number" class="form-label">Client Number</label>
                        <input type="text" class="form-control" id="complaint-client-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="complaint-details" class="form-label">Complaint Details</label>
                        <textarea class="form-control" id="complaint-details" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger">Submit Complaint</button>
                </form>

                <div id="complaints-list" class="mt-5">
                    <h3>Submitted Complaints</h3>
                    <ul class="list-group mt-3" id="complaints-ul">
                        <!-- Dynamic Complaints -->
                    </ul>
                </div>
            </section>

            <!-- View Account -->
            <section id="viewAccount-section" class="mt-4 d-none">
                <h2>View Account</h2>
                <form id="view-account-form" class="mt-4">
                    <div class="mb-3">
                        <label for="view-account-client-number" class="form-label">Client Number</label>
                        <input type="text" class="form-control" id="view-account-client-number" placeholder="Enter client number" required>
                    </div>
                    <button type="submit" class="btn btn-primary">View Account</button>
                </form>
                <div id="account-details" class="mt-4 d-none">
                    <h3>Account Details</h3>
                    <table class="table table-bordered mt-3">
                        <tbody id="account-details-body">
                            <!-- Dynamic Account Details -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Refunds Section -->
            <section id="refunds-section" class="mt-4 d-none">
                <h2>Refunds</h2>
                <form id="refund-form" class="mt-4">
                    <div class="mb-3">
                        <label for="refund-client-number" class="form-label">Client Number</label>
                        <input type="text" class="form-control" id="refund-client-number" placeholder="Enter client number" required>
                    </div>
                    <div class="mb-3">
                        <label for="refund-amount" class="form-label">Refund Amount</label>
                        <input type="number" class="form-control" id="refund-amount" placeholder="Enter amount" required>
                    </div>
                    <button type="submit" class="btn btn-warning">Process Refund</button>
                </form>
                <div id="refunds-list" class="mt-5">
                    <h3>Processed Refunds</h3>
                    <table class="table table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Refund ID</th>
                                <th>Client No.</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="refunds-body">
                            <!-- Dynamic Refunds -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Journal Section (added placeholder) -->
            <section id="journal-section" class="mt-4 d-none">
                <h2>Journal</h2>
                <p>Placeholder for Journal content.</p>
            </section>

            <!-- Unmet Cancellation Section (added placeholder) -->
            <section id="unmetCancellation-section" class="mt-4 d-none">
                <h2>Unmet Cancellation</h2>
                <p>Placeholder for Unmet Cancellation content.</p>
            </section>

            <!-- History Section (added placeholder) -->
            <section id="history-section" class="mt-4 d-none">
                <h2>History</h2>
                <p>Placeholder for Policy/Claims History.</p>
            </section>

            <!-- Current Claims -->
            <section id="currentClaims-section" class="mt-4 d-none">
                <h2>Current Claims</h2>
                <div class="mb-3">
                    <button class="btn btn-primary" id="add-claim-btn">Add New Claim</button>
                </div>
                <table class="table table-striped mt-4">
                    <thead>
                        <tr>
                            <th>Claim ID</th>
                            <th>Client No.</th>
                            <th>Policy No.</th>
                            <th>Status</th>
                            <th>Date Filed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="current-claims-body">
                        <!-- Dynamic Claims -->
                    </tbody>
                </table>
            </section>

            <!-- Claims Details -->
            <section id="claimsDetails-section" class="mt-4 d-none">
                <h2>Claims Details</h2>
                <form id="claims-details-form" class="mt-4">
                    <div class="mb-3">
                        <label for="claims-details-claim-id" class="form-label">Claim ID</label>
                        <input type="text" class="form-control" id="claims-details-claim-id" placeholder="Enter claim ID" required>
                    </div>
                    <button type="submit" class="btn btn-secondary">View Details</button>
                </form>
                <div id="claim-details-display" class="mt-4 d-none">
                    <h3>Claim Details</h3>
                    <table class="table table-bordered mt-3">
                        <tbody id="claim-details-body">
                            <!-- Dynamic Claim Details -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Claims Endorsements -->
            <section id="claimsEndorsements-section" class="mt-4 d-none">
                <h2>Claims Endorsements</h2>
                <form id="claims-endorsements-form" class="mt-4">
                    <div class="mb-3">
                        <label for="endorsement-claim-id" class="form-label">Claim ID</label>
                        <input type="text" class="form-control" id="endorsement-claim-id" placeholder="Enter claim ID" required>
                    </div>
                    <div class="mb-3">
                        <label for="endorsement-details" class="form-label">Endorsement Details</label>
                        <textarea class="form-control" id="endorsement-details" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-info">Add Endorsement</button>
                </form>
                <div id="endorsements-list" class="mt-5">
                    <h3>Claim Endorsements</h3>
                    <ul class="list-group mt-3" id="endorsements-ul">
                        <!-- Dynamic Endorsements -->
                    </ul>
                </div>
            </section>

            <!-- Claims Payment (added placeholder) -->
            <section id="claimsPayment-section" class="mt-4 d-none">
                <h2>Claims Payment</h2>
                <p>Placeholder for Claims Payment functionalities.</p>
                <!-- If you have a claims-payment-form or table, add them here -->
            </section>

            <!-- Claims Parties -->
            <section id="claimsParties-section" class="mt-4 d-none">
                <h2>Claims Parties</h2>
                <form id="claims-parties-form" class="mt-4">
                    <div class="mb-3">
                        <label for="party-claim-id" class="form-label">Claim ID</label>
                        <input type="text" class="form-control" id="party-claim-id" placeholder="Enter claim ID" required>
                    </div>
                    <div class="mb-3">
                        <label for="party-name" class="form-label">Party Name</label>
                        <input type="text" class="form-control" id="party-name" placeholder="Enter party name" required>
                    </div>
                    <div class="mb-3">
                        <label for="party-role" class="form-label">Role</label>
                        <input type="text" class="form-control" id="party-role" placeholder="Enter role (e.g., Insured, Witness)" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Party</button>
                </form>
                <div id="claims-parties-list" class="mt-5">
                    <h3>Claim Parties</h3>
                    <ul class="list-group mt-3" id="claims-parties-ul">
                        <!-- Dynamic Parties -->
                    </ul>
                </div>
            </section>

            <!-- Run Report -->
            <section id="runReport-section" class="mt-4 d-none">
                <h2>Run Report</h2>
                <form id="run-report-form" class="mt-4">
                    <div class="mb-3">
                        <label for="report-type" class="form-label">Report Type</label>
                        <select class="form-select" id="report-type" required>
                            <option value="">Select Report Type</option>
                            <option value="monthlySales">Monthly Sales</option>
                            <option value="claimsSummary">Claims Summary</option>
                            <option value="clientList">Client List</option>
                            <option value="refundsReport">Refunds Report</option>
                            <option value="paymentsReport">Payments Report</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </form>
                <div id="report-display" class="mt-4 d-none">
                    <h3>Report: <span id="report-title"></span></h3>
                    <div id="report-content" class="mt-3">
                        <!-- Dynamic Report Content -->
                    </div>
                </div>
            </section>

            <!-- Loss Ratio Analysis -->
            <section id="lossRatio-section" class="mt-4 d-none">
                <h2>Loss Ratio Analysis</h2>
                <p>This section provides analysis on the loss ratios across all policies.</p>
                <canvas id="loss-ratio-chart" width="400" height="200"></canvas>
            </section>

            <!-- Month-End Report History -->
            <section id="monthEndHistory-section" class="mt-4 d-none">
                <h2>Month-End Report History</h2>
                <table class="table table-striped mt-4">
                    <thead>
                        <tr>
                            <th>Report ID</th>
                            <th>Report Type</th>
                            <th>Date Generated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="month-end-history-body">
                        <!-- Dynamic Reports -->
                    </tbody>
                </table>
            </section>

            <!-- Manager Reports -->
            <section id="managerReports-section" class="mt-4 d-none">
                <h2>Manager Reports</h2>
                <p>This section allows managers to generate specialized reports.</p>
                <form id="manager-reports-form" class="mt-4">
                    <div class="mb-3">
                        <label for="manager-report-type" class="form-label">Report Type</label>
                        <select class="form-select" id="manager-report-type" required>
                            <option value="">Select Report Type</option>
                            <option value="agentPerformance">Agent Performance</option>
                            <option value="policyGrowth">Policy Growth</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Generate Manager Report</button>
                </form>
                <div id="manager-report-display" class="mt-4 d-none">
                    <h3>Manager Report: <span id="manager-report-title"></span></h3>
                    <div id="manager-report-content" class="mt-3">
                        <!-- Dynamic Manager Report Content -->
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="clientModalLabel">Add New Client</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="client-form">
                <div class="mb-3">
                    <label for="modal-clientName" class="form-label">Client Name</label>
                    <input type="text" class="form-control" id="modal-clientName" required>
                </div>
                <div class="mb-3">
                    <label for="modal-idNumber" class="form-label">ID Number</label>
                    <input type="text" class="form-control" id="modal-idNumber" required>
                </div>
                <div class="mb-3">
                    <label for="modal-commission" class="form-label">Commission</label>
                    <input type="text" class="form-control" id="modal-commission" placeholder="$0.00" required>
                </div>
                <div class="mb-3">
                    <label for="modal-productInfo" class="form-label">Product Info</label>
                    <input type="text" class="form-control" id="modal-productInfo" required>
                </div>
                <div class="mb-3">
                    <label for="modal-lossRatio" class="form-label">Loss Ratio</label>
                    <input type="number" step="0.01" class="form-control" id="modal-lossRatio" placeholder="0.00" required>
                </div>
                <div class="mb-3">
                    <label for="modal-status" class="form-label">Status</label>
                    <select class="form-select" id="modal-status" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save Client</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="claimModal" tabindex="-1" aria-labelledby="claimModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="claimModalLabel">Add New Claim</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="claim-form">
                <div class="mb-3">
                    <label for="modal-claim-client-no" class="form-label">Client Number</label>
                    <input type="text" class="form-control" id="modal-claim-client-no" placeholder="Enter client number" required>
                </div>
                <div class="mb-3">
                    <label for="modal-claim-policy-no" class="form-label">Policy Number</label>
                    <input type="text" class="form-control" id="modal-claim-policy-no" placeholder="Enter policy number" required>
                </div>
                <div class="mb-3">
                    <label for="modal-claim-status" class="form-label">Status</label>
                    <select class="form-select" id="modal-claim-status" required>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modal-claim-date" class="form-label">Date Filed</label>
                    <input type="date" class="form-control" id="modal-claim-date" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Claim</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Data Handling
            let data = [];
            let recentActivities = [];
            let complaints = [];
            let refunds = [];
            let payments = [];
            let currentClaims = [];
            let endorsements = [];
            let claimsParties = [];
            let monthEndReports = [];
            let managerReports = [];
            let policies = []; // Added this so getCompanyPolicies() won't fail

            window.onload = function() {
                const currentUser = getCurrentUser();
                if (currentUser && currentUser.company) {
                    document.getElementById('company-name').textContent = currentUser.company;
                }

                loadData();
                data = getCompanyClients();
                currentClaims = getCompanyClaims();

                updateDashboard();
                renderClientsList();
                renderComplaintsList();
                renderRefundsList();
                renderPaymentsList();
                renderRecentActivities();
                renderCurrentClaims();
                renderEndorsementsList();
                renderClaimsPartiesList();
                renderMonthEndHistory();
                renderManagerReportsList();
                renderLossRatioChart();
            };

            const clientModal = new bootstrap.Modal(document.getElementById('clientModal'), {keyboard: false});
            const claimModal = new bootstrap.Modal(document.getElementById('claimModal'), {keyboard: false});

            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    document.querySelectorAll('#main-sections > section').forEach(section => {
                        section.classList.add('d-none');
                    });
                    // Show the selected section if it exists
                    const sectionToShow = document.getElementById(target+'-section');
                    if(sectionToShow) {
                        sectionToShow.classList.remove('d-none');
                    }
                });
            });

            document.getElementById('add-client-btn').addEventListener('click', function() {
                document.getElementById('client-form').reset();
                document.getElementById('clientModalLabel').textContent = 'Add New Client';
                document.getElementById('client-form').removeAttribute('data-edit-client-no');
                clientModal.show();
            });

            document.getElementById('client-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return;
                }
                const clientName = document.getElementById('modal-clientName').value.trim();
                const idNumber = document.getElementById('modal-idNumber').value.trim();
                const commission = document.getElementById('modal-commission').value.trim();
                const productInfo = document.getElementById('modal-productInfo').value.trim();
                const lossRatio = document.getElementById('modal-lossRatio').value.trim();
                const status = document.getElementById('modal-status').value;

                if(clientName === '' || idNumber === '' || commission === '' || productInfo === '' || lossRatio === '' || status === '') {
                    alert('Please fill in all required fields.');
                    return;
                }

                const isEdit = this.hasAttribute('data-edit-client-no');
                if(isEdit) {
                    const clientNo = this.getAttribute('data-edit-client-no');
                    const client = data.find(c => c.clientNo === clientNo);
                    if(!client) {
                        alert('Client not found.');
                        return;
                    }
                    client.clientName = clientName;
                    client.idNumber = idNumber;
                    client.commission = commission;
                    client.productInfo = productInfo;
                    client.lossRatio = lossRatio;
                    client.status = status;

                    recentActivities.unshift({
                        timestamp: new Date().toLocaleString(),
                        description: `Updated client "${client.clientName}" (Client No.: ${client.clientNo}).`
                    });

                    updateDashboard();
                    renderClientsList();
                    saveData();
                    clientModal.hide();
                    const viewedClientNo = document.getElementById('client-no').textContent;
                    if(viewedClientNo === client.clientNo) {
                        viewClientDetails(client.clientNo);
                    }
                } else {
                    const clientNo = generateClientNo();
                    const newClient = {
                        itemNo: data.length > 0 ? data[data.length - 1].itemNo + 1 : 1,
                        clientNo: clientNo,
                        clientName: clientName,
                        policyNo: 'N/A',
                        claimNo: 'N/A',
                        status: status,
                        commission: commission,
                        productInfo: productInfo,
                        lossRatio: lossRatio,
                        idNumber: idNumber,
                        company: currentUser.company
                    };
                    data.push(newClient);
                    recentActivities.unshift({
                        timestamp: new Date().toLocaleString(),
                        description: `Added new client "${clientName}" with Client No.: ${clientNo}.`
                    });
                    updateDashboard();
                    renderClientsList();
                    saveData();
                    clientModal.hide();
                }
            });

            function generateClientNo() {
                let clientNo;
                do {
                    const uniqueNumber = Math.floor(10000 + Math.random() * 90000);
                    clientNo = 'PFC' + uniqueNumber;
                } while(data.some(client => client.clientNo === clientNo));
                return clientNo;
            }

            function renderClientsList() {
                const companyClients = getCompanyClients();
                const clientsListBody = document.getElementById('clients-list-body');
                clientsListBody.innerHTML = '';
                if(companyClients.length === 0) {
                    clientsListBody.innerHTML = '<tr><td colspan="7" class="text-center">No clients available.</td></tr>';
                    return;
                }
                companyClients.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${client.itemNo}</td>
                        <td>${client.clientNo}</td>
                        <td>${client.clientName}</td>
                        <td>${client.policyNo}</td>
                        <td>${client.claimNo}</td>
                        <td>${client.status}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-client-btn" data-client-no="${client.clientNo}">View</button>
                            <button class="btn btn-sm btn-warning edit-client-btn" data-client-no="${client.clientNo}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-client-btn" data-client-no="${client.clientNo}">Delete</button>
                        </td>
                    `;
                    clientsListBody.appendChild(row);
                });

                document.querySelectorAll('.view-client-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const clientNo = this.getAttribute('data-client-no');
                        viewClientDetails(clientNo);
                    });
                });

                document.querySelectorAll('.edit-client-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const clientNo = this.getAttribute('data-client-no');
                        openEditClientModal(clientNo);
                    });
                });

                document.querySelectorAll('.delete-client-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const clientNo = this.getAttribute('data-client-no');
                        deleteClient(clientNo);
                    });
                });
            }

            function viewClientDetails(clientNo) {
                const client = data.find(c => c.clientNo === clientNo);
                if(!client) {
                    alert('Client not found.');
                    return;
                }
                document.getElementById('client-no').textContent = client.clientNo;
                document.getElementById('client-name').textContent = client.clientName;
                document.getElementById('commission').textContent = client.commission;
                document.getElementById('policy-no').textContent = client.policyNo;
                document.getElementById('claim-no').textContent = client.claimNo;
                document.getElementById('product-info').textContent = client.productInfo;
                document.getElementById('status').textContent = client.status;
                document.getElementById('loss-ratio').textContent = client.lossRatio;
                document.getElementById('info-bar').style.display = 'flex';
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Viewed details for client "${client.clientName}" (Client No.: ${clientNo}).`
                });
                updateDashboard();
                saveData();
            }

            function openEditClientModal(clientNo) {
                const client = data.find(c => c.clientNo === clientNo);
                if(!client) {
                    alert('Client not found.');
                    return;
                }
                document.getElementById('clientModalLabel').textContent = `Edit Client - ${client.clientName}`;
                document.getElementById('modal-clientName').value = client.clientName;
                document.getElementById('modal-idNumber').value = client.idNumber;
                document.getElementById('modal-commission').value = client.commission;
                document.getElementById('modal-productInfo').value = client.productInfo;
                document.getElementById('modal-lossRatio').value = client.lossRatio;
                document.getElementById('modal-status').value = client.status;
                document.getElementById('client-form').setAttribute('data-edit-client-no', client.clientNo);
                clientModal.show();
            }

            function deleteClient(clientNo) {
                if(!confirm('Are you sure you want to delete this client? This action cannot be undone.')) {
                    return;
                }
                const clientIndex = data.findIndex(c => c.clientNo === clientNo);
                if(clientIndex === -1) {
                    alert('Client not found.');
                    return;
                }
                const deletedClient = data.splice(clientIndex, 1)[0];
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Deleted client "${deletedClient.clientName}" (Client No.: ${clientNo}).`
                });
                updateDashboard();
                renderClientsList();
                saveData();
                const viewedClientNo = document.getElementById('client-no').textContent;
                if(viewedClientNo === clientNo) {
                    document.getElementById('info-bar').style.display = 'none';
                }
            }

            document.getElementById('client-search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const searchName = document.getElementById('search-client-name').value.trim().toLowerCase();
                const searchNumber = document.getElementById('search-client-number').value.trim().toLowerCase();
                const searchPolicy = document.getElementById('search-policy-number').value.trim().toLowerCase();

                let filteredData = data.filter(client => {
                    return (
                        (searchName === '' || client.clientName.toLowerCase().includes(searchName)) &&
                        (searchNumber === '' || client.clientNo.toLowerCase().includes(searchNumber)) &&
                        (searchPolicy === '' || client.policyNo.toLowerCase().includes(searchPolicy))
                    );
                });

                const resultsBody = document.getElementById('search-results-body');
                resultsBody.innerHTML = '';
                if(filteredData.length === 0) {
                    resultsBody.innerHTML = '<tr><td colspan="7" class="text-center">No results found.</td></tr>';
                } else {
                    filteredData.forEach(client => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${client.itemNo}</td>
                            <td>${client.clientNo}</td>
                            <td>${client.clientName}</td>
                            <td>${client.policyNo}</td>
                            <td>${client.claimNo}</td>
                            <td>${client.status}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-client-btn" data-client-no="${client.clientNo}">View</button>
                                <button class="btn btn-sm btn-warning edit-client-btn" data-client-no="${client.clientNo}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-client-btn" data-client-no="${client.clientNo}">Delete</button>
                            </td>
                        `;
                        resultsBody.appendChild(row);
                    });
                }

                document.getElementById('search-results').classList.remove('d-none');
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Performed client search. Found ${filteredData.length} result(s).`
                });
                updateDashboard();
                document.querySelectorAll('.view-client-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const clientNo = this.getAttribute('data-client-no');
                        viewClientDetails(clientNo);
                    });
                });

                document.querySelectorAll('.edit-client-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const clientNo = this.getAttribute('data-client-no');
                        openEditClientModal(clientNo);
                    });
                });

                document.querySelectorAll('.delete-client-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const clientNo = this.getAttribute('data-client-no');
                        deleteClient(clientNo);
                    });
                });

                saveData();
            });

            document.getElementById('complaint-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientNumber = document.getElementById('complaint-client-number').value.trim();
                const complaintDetails = document.getElementById('complaint-details').value.trim();
                if(clientNumber === '' || complaintDetails === '') {
                    alert('Please fill in all required fields.');
                    return;
                }
                const client = data.find(c => c.clientNo === clientNumber);
                if(!client) {
                    alert('Client not found.');
                    return;
                }
                const newComplaint = {
                    id: complaints.length + 1,
                    clientNo: clientNumber,
                    clientName: client.clientName,
                    details: complaintDetails,
                    status: 'Pending',
                    timestamp: new Date().toLocaleString()
                };
                complaints.push(newComplaint);
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Submitted complaint for client "${client.clientName}" (Client No.: ${clientNumber}).`
                });
                updateDashboard();
                renderComplaintsList();
                saveData();
                document.getElementById('complaint-form').reset();
            });

            function renderComplaintsList() {
                const complaintsUl = document.getElementById('complaints-ul');
                complaintsUl.innerHTML = '';
                if(complaints.length === 0) {
                    complaintsUl.innerHTML = '<li class="list-group-item">No complaints submitted.</li>';
                    return;
                }
                complaints.forEach(complaint => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.innerHTML = `
                        <strong>Client No.: ${complaint.clientNo}</strong> - ${complaint.clientName}<br>
                        <em>${complaint.details}</em><br>
                        <small>Status: ${complaint.status} | Submitted: ${complaint.timestamp}</small>
                    `;
                    complaintsUl.appendChild(li);
                });
            }

            document.getElementById('view-account-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientNumber = document.getElementById('view-account-client-number').value.trim();
                if(clientNumber === '') {
                    alert('Please enter a Client Number.');
                    return;
                }
                const client = data.find(c => c.clientNo === clientNumber);
                if(!client) {
                    alert('Client not found.');
                    return;
                }
                const accountDetailsBody = document.getElementById('account-details-body');
                accountDetailsBody.innerHTML = `
                    <tr>
                        <th>Client No.</th>
                        <td>${client.clientNo}</td>
                    </tr>
                    <tr>
                        <th>Client Name</th>
                        <td>${client.clientName}</td>
                    </tr>
                    <tr>
                        <th>Commission</th>
                        <td>${client.commission}</td>
                    </tr>
                    <tr>
                        <th>Policy No.</th>
                        <td>${client.policyNo}</td>
                    </tr>
                    <tr>
                        <th>Claim No.</th>
                        <td>${client.claimNo}</td>
                    </tr>
                    <tr>
                        <th>Product Info</th>
                        <td>${client.productInfo}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>${client.status}</td>
                    </tr>
                    <tr>
                        <th>Loss Ratio</th>
                        <td>${client.lossRatio}</td>
                    </tr>
                `;
                document.getElementById('account-details').classList.remove('d-none');
                viewClientDetails(client.clientNo);
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Viewed account details for client "${client.clientName}" (Client No.: ${clientNumber}).`
                });
                updateDashboard();
                saveData();
            });

            document.getElementById('refund-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientNumber = document.getElementById('refund-client-number').value.trim();
                const refundAmount = parseFloat(document.getElementById('refund-amount').value.trim());
                if(clientNumber === '' || isNaN(refundAmount) || refundAmount <= 0) {
                    alert('Please enter a valid Client Number and Refund Amount.');
                    return;
                }
                const client = data.find(c => c.clientNo === clientNumber);
                if(!client) {
                    alert('Client not found.');
                    return;
                }
                const newRefund = {
                    refundId: refunds.length + 1,
                    clientNo: clientNumber,
                    amount: refundAmount.toFixed(2),
                    date: new Date().toLocaleString()
                };
                refunds.push(newRefund);
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Processed refund of $${refundAmount.toFixed(2)} for client "${client.clientName}" (Client No.: ${clientNumber}).`
                });
                updateDashboard();
                renderRefundsList();
                saveData();
                document.getElementById('refund-form').reset();
            });

            function renderRefundsList() {
                const refundsBody = document.getElementById('refunds-body');
                refundsBody.innerHTML = '';
                if(refunds.length === 0) {
                    refundsBody.innerHTML = '<tr><td colspan="4" class="text-center">No refunds processed.</td></tr>';
                    return;
                }
                refunds.forEach(refund => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${refund.refundId}</td>
                        <td>${refund.clientNo}</td>
                        <td>$${refund.amount}</td>
                        <td>${refund.date}</td>
                    `;
                    refundsBody.appendChild(row);
                });
            }

            // If you implement claims-payment-form in the future, you can handle its logic here.

            document.getElementById('run-report-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const reportType = document.getElementById('report-type').value;
                if(reportType === '') {
                    alert('Please select a report type.');
                    return;
                }
                let reportContent = '';
                let reportTitle = '';
                switch(reportType) {
                    case 'monthlySales':
                        reportTitle = 'Monthly Sales Report';
                        reportContent = generateMonthlySalesReport();
                        break;
                    case 'claimsSummary':
                        reportTitle = 'Claims Summary Report';
                        reportContent = generateClaimsSummaryReport();
                        break;
                    case 'clientList':
                        reportTitle = 'Client List Report';
                        reportContent = generateClientListReport();
                        break;
                    case 'refundsReport':
                        reportTitle = 'Refunds Report';
                        reportContent = generateRefundsReport();
                        break;
                    case 'paymentsReport':
                        reportTitle = 'Payments Report';
                        reportContent = generatePaymentsReport();
                        break;
                    default:
                        reportTitle = 'Unknown Report';
                        reportContent = '<p>Report generation not implemented.</p>';
                }
                document.getElementById('report-title').textContent = reportTitle;
                document.getElementById('report-content').innerHTML = reportContent;
                document.getElementById('report-display').classList.remove('d-none');
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Generated report "${reportTitle}".`
                });
                updateDashboard();
                saveData();
            });

            function generateMonthlySalesReport() {
                let totalPolicies = data.length;
                let activePolicies = data.filter(c => c.status === 'Active').length;
                let claimsMade = currentClaims.length;
                return `
                    <ul>
                        <li>Total Policies Sold: ${totalPolicies}</li>
                        <li>Active Policies: ${activePolicies}</li>
                        <li>Claims Made: ${claimsMade}</li>
                    </ul>
                `;
            }

            function generateClaimsSummaryReport() {
                let totalClaims = currentClaims.length;
                let paidClaims = currentClaims.filter(c => c.status === 'Paid').length;
                let pendingClaims = totalClaims - paidClaims;
                return `
                    <ul>
                        <li>Total Claims: ${totalClaims}</li>
                        <li>Paid Claims: ${paidClaims}</li>
                        <li>Pending Claims: ${pendingClaims}</li>
                    </ul>
                `;
            }

            function generateClientListReport() {
                if(data.length === 0) {
                    return '<p>No clients available to display.</p>';
                }
                let clientList = '<table class="table table-bordered"><thead><tr><th>Client No.</th><th>Client Name</th><th>ID Number</th></tr></thead><tbody>';
                data.forEach(client => {
                    clientList += `<tr><td>${client.clientNo}</td><td>${client.clientName}</td><td>${client.idNumber || 'N/A'}</td></tr>`;
                });
                clientList += '</tbody></table>';
                return clientList;
            }

            function generateRefundsReport() {
                if(refunds.length === 0) {
                    return '<p>No refunds processed.</p>';
                }
                let refundsReport = '<table class="table table-bordered"><thead><tr><th>Refund ID</th><th>Client No.</th><th>Amount</th><th>Date</th></tr></thead><tbody>';
                refunds.forEach(refund => {
                    refundsReport += `<tr><td>${refund.refundId}</td><td>${refund.clientNo}</td><td>$${refund.amount}</td><td>${refund.date}</td></tr>`;
                });
                refundsReport += '</tbody></table>';
                return refundsReport;
            }

            function generatePaymentsReport() {
                if(payments.length === 0) {
                    return '<p>No payments processed.</p>';
                }
                let paymentsReport = '<table class="table table-bordered"><thead><tr><th>Payment ID</th><th>Claim ID</th><th>Amount</th><th>Date</th></tr></thead><tbody>';
                payments.forEach(payment => {
                    paymentsReport += `<tr><td>${payment.paymentId}</td><td>${payment.claimId}</td><td>$${payment.amount}</td><td>${payment.date}</td></tr>`;
                });
                paymentsReport += '</tbody></table>';
                return paymentsReport;
            }

            function updateDashboard() {
                document.getElementById('total-clients').textContent = data.length;
                document.getElementById('active-policies').textContent = data.filter(d => d.status === 'Active').length;
                document.getElementById('pending-claims').textContent = currentClaims.filter(c => c.status !== 'Paid').length;
                document.getElementById('notifications').textContent = recentActivities.length;
                renderRecentActivities();
            }

            function renderRecentActivities() {
                const activitiesDiv = document.getElementById('recent-activities');
                activitiesDiv.innerHTML = '';
                if(recentActivities.length === 0) {
                    activitiesDiv.innerHTML = '<p>No recent activities.</p>';
                    return;
                }
                recentActivities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.classList.add('activity-item');
                    activityItem.innerHTML = `<i class="fas fa-circle"></i> <span>${activity.timestamp} - ${activity.description}</span>`;
                    activitiesDiv.appendChild(activityItem);
                });
            }

            function saveData() {
                localStorage.setItem('insuranceData', JSON.stringify({
                    data,
                    recentActivities,
                    complaints,
                    refunds,
                    payments,
                    currentClaims,
                    endorsements,
                    claimsParties,
                    monthEndReports,
                    managerReports
                }));
            }

            function loadData() {
                const storedData = localStorage.getItem('insuranceData');
                if(storedData) {
                    const parsedData = JSON.parse(storedData);
                    data = parsedData.data || [];
                    recentActivities = parsedData.recentActivities || [];
                    complaints = parsedData.complaints || [];
                    refunds = parsedData.refunds || [];
                    payments = parsedData.payments || [];
                    currentClaims = parsedData.currentClaims || [];
                    endorsements = parsedData.endorsements || [];
                    claimsParties = parsedData.claimsParties || [];
                    monthEndReports = parsedData.monthEndReports || [];
                    managerReports = parsedData.managerReports || [];
                }
            }

            document.getElementById('import-clients-btn').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('import-clients-input').click();
            });

            document.getElementById('import-clients-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if(Array.isArray(importedData)) {
                            let importedCount = 0;
                            importedData.forEach(client => {
                                if(client.clientNo && !data.some(existingClient => existingClient.clientNo === client.clientNo)) {
                                    data.push(client);
                                    recentActivities.unshift({
                                        timestamp: new Date().toLocaleString(),
                                        description: `Imported client "${client.clientName}" (Client No.: ${client.clientNo}).`
                                    });
                                    importedCount++;
                                }
                            });
                            alert(`Successfully imported ${importedCount} client(s).`);
                            renderClientsList();
                            updateDashboard();
                            saveData();
                        } else {
                            alert('Invalid data format. Please upload a valid JSON file.');
                        }
                    } catch (error) {
                        alert('Error parsing JSON file. Please ensure it is correctly formatted.');
                    }
                };
                reader.readAsText(file);
            });

            document.getElementById('export-clients-btn').addEventListener('click', function(e) {
                e.preventDefault();
                if(data.length === 0) {
                    alert('No clients available to export.');
                    return;
                }
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'clients_export.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            document.getElementById('add-claim-btn').addEventListener('click', function() {
                document.getElementById('claim-form').reset();
                document.getElementById('claimModalLabel').textContent = 'Add New Claim';
                claimModal.show();
            });

            document.getElementById('claim-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientNo = document.getElementById('modal-claim-client-no').value.trim();
                const policyNo = document.getElementById('modal-claim-policy-no').value.trim();
                const status = document.getElementById('modal-claim-status').value;
                const dateFiled = document.getElementById('modal-claim-date').value;
                if(clientNo === '' || policyNo === '' || status === '' || dateFiled === '') {
                    alert('Please fill in all required fields.');
                    return;
                }
                const client = data.find(c => c.clientNo === clientNo);
                if(!client) {
                    alert('Client not found.');
                    return;
                }
                const claimId = generateClaimId();
                const newClaim = {
                    claimId: claimId,
                    clientNo: clientNo,
                    policyNo: policyNo,
                    status: status,
                    dateFiled: dateFiled
                };
                currentClaims.push(newClaim);
                client.claimNo = claimId;
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Added new claim "${claimId}" for client "${client.clientName}" (Client No.: ${clientNo}).`
                });
                updateDashboard();
                renderCurrentClaims();
                saveData();
                claimModal.hide();
            });

            function generateClaimId() {
                let claimId;
                do {
                    const uniqueNumber = Math.floor(10000 + Math.random() * 90000);
                    claimId = 'CLM' + uniqueNumber;
                } while(currentClaims.some(claim => claim.claimId === claimId));
                return claimId;
            }

            function renderCurrentClaims() {
                renderCurrentClaimsTable();
            }

            function renderCurrentClaimsTable() {
                const claimsBody = document.getElementById('current-claims-body');
                claimsBody.innerHTML = '';
                if(currentClaims.length === 0) {
                    claimsBody.innerHTML = '<tr><td colspan="6" class="text-center">No current claims.</td></tr>';
                    return;
                }
                currentClaims.forEach(claim => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${claim.claimId}</td>
                        <td>${claim.clientNo}</td>
                        <td>${claim.policyNo}</td>
                        <td>${claim.status}</td>
                        <td>${claim.dateFiled}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-claim-btn" data-claim-id="${claim.claimId}">View</button>
                            <button class="btn btn-sm btn-warning update-claim-status-btn" data-claim-id="${claim.claimId}">Update Status</button>
                        </td>
                    `;
                    claimsBody.appendChild(row);
                });
                document.querySelectorAll('.view-claim-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const claimId = this.getAttribute('data-claim-id');
                        viewClaimDetails(claimId);
                    });
                });

                document.querySelectorAll('.update-claim-status-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const claimId = this.getAttribute('data-claim-id');
                        updateClaimStatus(claimId);
                    });
                });
            }

            function viewClaimDetails(claimId) {
                const claim = currentClaims.find(c => c.claimId === claimId);
                if(!claim) {
                    alert('Claim not found.');
                    return;
                }
                const claimDetailsBody = document.getElementById('claim-details-body');
                claimDetailsBody.innerHTML = `
                    <tr>
                        <th>Claim ID</th>
                        <td>${claim.claimId}</td>
                    </tr>
                    <tr>
                        <th>Client No.</th>
                        <td>${claim.clientNo}</td>
                    </tr>
                    <tr>
                        <th>Policy No.</th>
                        <td>${claim.policyNo}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>${claim.status}</td>
                    </tr>
                    <tr>
                        <th>Date Filed</th>
                        <td>${claim.dateFiled}</td>
                    </tr>
                `;
                document.getElementById('claim-details-display').classList.remove('d-none');
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Viewed details for claim "${claimId}".`
                });
                updateDashboard();
                saveData();
            }

            function updateClaimStatus(claimId) {
                const claim = currentClaims.find(c => c.claimId === claimId);
                if(!claim) {
                    alert('Claim not found.');
                    return;
                }
                const newStatus = prompt('Enter new status for the claim (e.g., Open, In Progress, Closed):', claim.status);
                if(newStatus === null || newStatus.trim() === '') {
                    alert('Invalid status entered.');
                    return;
                }
                claim.status = newStatus.trim();
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Updated status of claim "${claimId}" to "${newStatus}".`
                });
                updateDashboard();
                renderCurrentClaims();
                saveData();
            }

            document.getElementById('claims-endorsements-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const claimId = document.getElementById('endorsement-claim-id').value.trim();
                const endorsementDetails = document.getElementById('endorsement-details').value.trim();
                if(claimId === '' || endorsementDetails === '') {
                    alert('Please fill in all required fields.');
                    return;
                }
                const claim = currentClaims.find(c => c.claimId === claimId);
                if(!claim) {
                    alert('Claim not found.');
                    return;
                }
                const newEndorsement = {
                    id: endorsements.length + 1,
                    claimId: claimId,
                    details: endorsementDetails,
                    timestamp: new Date().toLocaleString()
                };
                endorsements.push(newEndorsement);
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Added endorsement to claim "${claimId}".`
                });
                renderEndorsementsList();
                saveData();
                document.getElementById('claims-endorsements-form').reset();
            });

            function renderEndorsementsList() {
                const endorsementsUl = document.getElementById('endorsements-ul');
                endorsementsUl.innerHTML = '';
                if(endorsements.length === 0) {
                    endorsementsUl.innerHTML = '<li class="list-group-item">No endorsements added.</li>';
                    return;
                }
                endorsements.forEach(endorsement => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.innerHTML = `
                        <strong>Claim ID: ${endorsement.claimId}</strong><br>
                        <em>${endorsement.details}</em><br>
                        <small>Added on: ${endorsement.timestamp}</small>
                    `;
                    endorsementsUl.appendChild(li);
                });
            }

            document.getElementById('claims-parties-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const claimId = document.getElementById('party-claim-id').value.trim();
                const partyName = document.getElementById('party-name').value.trim();
                const partyRole = document.getElementById('party-role').value.trim();
                if(claimId === '' || partyName === '' || partyRole === '') {
                    alert('Please fill in all required fields.');
                    return;
                }
                const claim = currentClaims.find(c => c.claimId === claimId);
                if(!claim) {
                    alert('Claim not found.');
                    return;
                }
                const newParty = {
                    id: claimsParties.length + 1,
                    claimId: claimId,
                    name: partyName,
                    role: partyRole,
                    timestamp: new Date().toLocaleString()
                };
                claimsParties.push(newParty);
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Added party "${partyName}" with role "${partyRole}" to claim "${claimId}".`
                });
                renderClaimsPartiesList();
                saveData();
                document.getElementById('claims-parties-form').reset();
            });

            function renderClaimsPartiesList() {
                const claimsPartiesUl = document.getElementById('claims-parties-ul');
                claimsPartiesUl.innerHTML = '';
                if(claimsParties.length === 0) {
                    claimsPartiesUl.innerHTML = '<li class="list-group-item">No parties added to claims.</li>';
                    return;
                }
                claimsParties.forEach(party => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.innerHTML = `
                        <strong>Claim ID: ${party.claimId}</strong><br>
                        <em>Name: ${party.name} | Role: ${party.role}</em><br>
                        <small>Added on: ${party.timestamp}</small>
                    `;
                    claimsPartiesUl.appendChild(li);
                });
            }

            function renderCurrentClaims() {
                renderCurrentClaimsTable();
            }

            function renderCurrentClaimsTable() {
                const claimsBody = document.getElementById('current-claims-body');
                claimsBody.innerHTML = '';
                if(currentClaims.length === 0) {
                    claimsBody.innerHTML = '<tr><td colspan="6" class="text-center">No current claims.</td></tr>';
                    return;
                }
                currentClaims.forEach(claim => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${claim.claimId}</td>
                        <td>${claim.clientNo}</td>
                        <td>${claim.policyNo}</td>
                        <td>${claim.status}</td>
                        <td>${claim.dateFiled}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-claim-btn" data-claim-id="${claim.claimId}">View</button>
                            <button class="btn btn-sm btn-warning update-claim-status-btn" data-claim-id="${claim.claimId}">Update Status</button>
                        </td>
                    `;
                    claimsBody.appendChild(row);
                });
                document.querySelectorAll('.view-claim-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const claimId = this.getAttribute('data-claim-id');
                        viewClaimDetails(claimId);
                    });
                });
                document.querySelectorAll('.update-claim-status-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const claimId = this.getAttribute('data-claim-id');
                        updateClaimStatus(claimId);
                    });
                });
            }

            function renderLossRatioChart() {
                const ctx = document.getElementById('loss-ratio-chart').getContext('2d');
                const labels = data.map(client => client.clientName);
                const lossRatios = data.map(client => parseFloat(client.lossRatio));
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Loss Ratio',
                            data: lossRatios,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Loss Ratio (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Clients'
                                }
                            }
                        }
                    }
                });
            }

            function renderMonthEndHistory() {
                const historyBody = document.getElementById('month-end-history-body');
                historyBody.innerHTML = '';
                if(monthEndReports.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="4" class="text-center">No month-end reports generated.</td></tr>';
                    return;
                }
                monthEndReports.forEach(report => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${report.reportId}</td>
                        <td>${report.reportType}</td>
                        <td>${report.dateGenerated}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-month-end-report-btn" data-report-id="${report.reportId}">View</button>
                            <button class="btn btn-sm btn-secondary download-month-end-report-btn" data-report-id="${report.reportId}">Download</button>
                        </td>
                    `;
                    historyBody.appendChild(row);
                });
                document.querySelectorAll('.view-month-end-report-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const reportId = this.getAttribute('data-report-id');
                        viewMonthEndReport(reportId);
                    });
                });
                document.querySelectorAll('.download-month-end-report-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const reportId = this.getAttribute('data-report-id');
                        downloadMonthEndReport(reportId);
                    });
                });
            }

            function viewMonthEndReport(reportId) {
                const report = monthEndReports.find(r => r.reportId === reportId);
                if(!report) {
                    alert('Report not found.');
                    return;
                }
                const reportContent = `
                    <h4>${report.reportType}</h4>
                    <p>Date Generated: ${report.dateGenerated}</p>
                    <pre>${report.content}</pre>
                `;
                alert(reportContent);
            }

            function downloadMonthEndReport(reportId) {
                const report = monthEndReports.find(r => r.reportId === reportId);
                if(!report) {
                    alert('Report not found.');
                    return;
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = `${report.reportType.replace(/\s+/g, '_')}_${report.reportId}.json`;
                a.click();
            }

            document.getElementById('manager-reports-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const reportType = document.getElementById('manager-report-type').value;
                if(reportType === '') {
                    alert('Please select a report type.');
                    return;
                }
                let reportContent = '';
                let reportTitle = '';
                switch(reportType) {
                    case 'agentPerformance':
                        reportTitle = 'Agent Performance Report';
                        reportContent = generateAgentPerformanceReport();
                        break;
                    case 'policyGrowth':
                        reportTitle = 'Policy Growth Report';
                        reportContent = generatePolicyGrowthReport();
                        break;
                    default:
                        reportTitle = 'Unknown Report';
                        reportContent = '<p>Report generation not implemented.</p>';
                }
                document.getElementById('manager-report-title').textContent = reportTitle;
                document.getElementById('manager-report-content').innerHTML = reportContent;
                document.getElementById('manager-report-display').classList.remove('d-none');
                recentActivities.unshift({
                    timestamp: new Date().toLocaleString(),
                    description: `Generated manager report "${reportTitle}".`
                });
                updateDashboard();
                saveData();
            });

            function generateAgentPerformanceReport() {
                return `
                    <p>Agent Performance Report is currently under development.</p>
                `;
            }

            function generatePolicyGrowthReport() {
                return `
                    <p>Policy Growth Report is currently under development.</p>
                `;
            }

            function renderManagerReportsList() {
                // Placeholder: Implement if needed
            }

            function getCurrentUser() {
                return JSON.parse(localStorage.getItem('currentUser'));
            }

            function getCompanyClients() {
                const currentUser = getCurrentUser();
                return data.filter(client => client.company === currentUser.company);
            }

            function getCompanyPolicies() {
                const currentUser = getCurrentUser();
                return policies.filter(policy => {
                    const client = data.find(c => c.clientNo === policy.clientNo);
                    return client && client.company === currentUser.company;
                });
            }

            function getCompanyClaims() {
                const currentUser = getCurrentUser();
                return currentClaims.filter(claim => {
                    const client = data.find(c => c.clientNo === claim.clientNo);
                    return client && client.company === currentUser.company;
                });
            }

            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>
