<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Safety Management System</title>
  <!-- Bootstrap CSS -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Font Awesome (Icons) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-Fo3rlrZj/k7ujTnH1zD1nS2Jo3/TwH+jfDq5O1NRJ/lY6UeVx+0C/E0SvkKGw1XEE+OqG3wFZ1Pb6gdbecF3JQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Custom CSS -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f4f5f7; }

    .sidebar {
      position: fixed;
      width: 240px;
      height: 100vh;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      color: #fff;
      padding-top: 1rem;
      overflow-y: auto;
    }
    .sidebar h4 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }
    .sidebar a {
      display: block;
      color: #ddd;
      padding: 0.75rem 1.25rem;
      text-decoration: none;
      transition: background 0.2s;
    }
    .sidebar a:hover,
    .sidebar a.active {
      background-color: #3b4e5d;
      color: #fff;
    }

    .content {
      margin-left: 240px;
      padding: 20px;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }
    .hidden-section { display: none; }
    .card {
      margin-bottom: 1.5rem;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .table-responsive { max-height: 400px; overflow-y: auto; }
    .no-data-row td { text-align: center; font-style: italic; color: #6c757d; }
    .chart-container { position: relative; height: 400px; width: 100%; }
    .btn-shadow { box-shadow: none; }
    .modal-content { border-radius: 6px; border: none; }
    .modal-header { border-bottom: 1px solid #e9ecef; }

    .search-filter {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .search-filter input, .search-filter select {
      flex: 1;
      min-width: 200px;
    }
    .export-btns {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* Modal for viewing license/photo in large */
    #viewPhotoModal img {
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h4>Menu</h4>
  <a href="#" class="navLink active" data-target="dashboardSection"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
  <a href="#" class="navLink" data-target="usersSection"><i class="fas fa-users me-2"></i>Users</a>
  <a href="#" class="navLink" data-target="vehiclesSection"><i class="fas fa-truck me-2"></i>Vehicles</a>
  <a href="#" class="navLink" data-target="incidentsSection"><i class="fas fa-exclamation-triangle me-2"></i>Incidents</a>
  <a href="#" class="navLink" data-target="reportsSection"><i class="fas fa-chart-line me-2"></i>Reports</a>
  <a href="#" class="navLink" data-target="complianceSection"><i class="fas fa-check-circle me-2"></i>Compliance</a>
  <a href="#" class="navLink" data-target="documentsSection"><i class="fas fa-file me-2"></i>Documents</a>
</div>

<!-- MAIN CONTENT -->
<div class="content">
  <!-- DASHBOARD -->
  <section id="dashboardSection">
    <h2>Dashboard Overview</h2>
    <div class="row">
      <div class="col-md-4">
        <div class="card text-white bg-primary">
          <div class="card-header">Notifications</div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item bg-primary text-white">
                License Expiry: <span id="licenseExpiryCount">0</span>
              </li>
              <li class="list-group-item bg-primary text-white">
                Overdue Checks: <span id="overdueChecksCount">0</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">Incidents Chart</div>
          <div class="card-body chart-container">
            <canvas id="dashboardChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- USERS -->
  <section id="usersSection" class="hidden-section">
    <h2>User Management</h2>
    <div class="export-btns">
      <button class="btn btn-outline-secondary" onclick="exportToCSV('users')"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
      <button class="btn btn-outline-secondary" onclick="exportToPDF('users')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </div>
    <div class="search-filter">
      <input type="text" id="usersSearch" placeholder="Search users..." oninput="filterUsers()" />
      <select id="usersFilter" onchange="filterUsers()">
        <option value="">All Roles</option>
        <option value="Admin">Admin</option>
        <option value="Employee">Employee</option>
        <option value="Manager">Manager</option>
      </select>
    </div>
    <button class="btn btn-success mb-3 btn-shadow" data-bs-toggle="modal" data-bs-target="#addUserModal">
      <i class="fas fa-user-plus me-2"></i>Add User
    </button>
    <div class="card">
      <div class="card-header">Employees & Users</div>
      <div class="card-body table-responsive">
        <table class="table table-striped" id="usersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Contact</th>
              <th>Role</th>
              <th>License</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- Populated by JavaScript --></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- VEHICLES -->
  <section id="vehiclesSection" class="hidden-section">
    <h2>Vehicle Management</h2>
    <div class="export-btns">
      <button class="btn btn-outline-secondary" onclick="exportToCSV('vehicles')"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
      <button class="btn btn-outline-secondary" onclick="exportToPDF('vehicles')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </div>
    <div class="search-filter">
      <input type="text" id="vehiclesSearch" placeholder="Search vehicles..." oninput="filterVehicles()" />
      <select id="vehiclesFilter" onchange="filterVehicles()">
        <option value="">All Drivers</option>
      </select>
    </div>
    <button class="btn btn-success mb-3 btn-shadow" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
      <i class="fas fa-plus me-2"></i>Add Vehicle
    </button>
    <div class="card">
      <div class="card-header">Vehicles</div>
      <div class="card-body table-responsive">
        <table class="table table-striped" id="vehiclesTable">
          <thead>
            <tr>
              <th>Make/Model</th>
              <th>Registration</th>
              <th>Driver</th>
              <th>Maintenance</th>
              <th>Insurance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- Populated by JavaScript --></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- INCIDENTS -->
  <section id="incidentsSection" class="hidden-section">
    <h2>Incident Reporting</h2>
    <div class="export-btns">
      <button class="btn btn-outline-secondary" onclick="exportToCSV('incidents')">
        <i class="fas fa-file-csv me-1"></i>Export CSV
      </button>
      <button class="btn btn-outline-secondary" onclick="exportToPDF('incidents')">
        <i class="fas fa-file-pdf me-1"></i>Export PDF
      </button>
    </div>
    <div class="search-filter">
      <input type="text" id="incidentsSearch" placeholder="Search incidents..." oninput="filterIncidents()" />
      <select id="incidentsFilter" onchange="filterIncidents()">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Under Review">Under Review</option>
        <option value="Resolved">Resolved</option>
      </select>
    </div>
    <button class="btn btn-success mb-3 btn-shadow" data-bs-toggle="modal" data-bs-target="#addIncidentModal">
      <i class="fas fa-exclamation-circle me-2"></i>Report Incident
    </button>
    <div class="card">
      <div class="card-header">Recent Incidents</div>
      <div class="card-body table-responsive">
        <table class="table table-striped" id="incidentsTable">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Description</th>
              <th>User</th>
              <th>Vehicle</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- Populated by JavaScript --></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="reportsSection" class="hidden-section">
    <h2>Reporting & Analytics</h2>
    <div class="export-btns">
      <button class="btn btn-outline-secondary" onclick="exportReportsPDF()">
        <i class="fas fa-file-pdf me-1"></i>Export Reports (PDF)
      </button>
    </div>
    <div class="card">
      <div class="card-header">Analytics Dashboard</div>
      <div class="card-body chart-container">
        <canvas id="reportsChart"></canvas>
      </div>
    </div>
  </section>

  <!-- COMPLIANCE -->
  <section id="complianceSection" class="hidden-section">
    <h2>Compliance Tracking</h2>
    <div class="card">
      <div class="card-header">License Renewals & Vehicle Inspections</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="card bg-warning text-dark">
              <div class="card-header">License Renewals</div>
              <div class="card-body">
                <h5 class="card-title"><span id="licenseRenewalsCount">0</span> Pending</h5>
                <p>Employees with licenses nearing expiry.</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-danger text-white">
              <div class="card-header">Vehicle Inspections</div>
              <div class="card-body">
                <h5 class="card-title"><span id="vehicleInspectionsCount">0</span> Overdue</h5>
                <p>Vehicles that require maintenance/inspection.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- DOCUMENTS -->
  <section id="documentsSection" class="hidden-section">
    <h2>Document Management</h2>
    <div class="export-btns">
      <button class="btn btn-outline-secondary" onclick="exportToCSV('documents')">
        <i class="fas fa-file-csv me-1"></i>Export CSV
      </button>
      <button class="btn btn-outline-secondary" onclick="exportToPDF('documents')">
        <i class="fas fa-file-pdf me-1"></i>Export PDF
      </button>
    </div>
    <button class="btn btn-success mb-3 btn-shadow" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
      <i class="fas fa-file-upload me-2"></i>Upload Document
    </button>
    <div class="card">
      <div class="card-header">All Documents</div>
      <div class="card-body table-responsive">
        <table class="table table-striped" id="documentsTable">
          <thead>
            <tr>
              <th>Doc Name</th>
              <th>File Type</th>
              <th>Uploaded By</th>
              <th>Preview</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- Populated by JavaScript --></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- MODALS -->

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="userName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="userName" required/>
            </div>
            <div class="col-md-6">
              <label for="userContact" class="form-label">Contact Info</label>
              <input type="text" class="form-control" id="userContact" required/>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="userRole" class="form-label">Job Title/Role</label>
              <input type="text" class="form-control" id="userRole" required/>
            </div>
            <div class="col-md-6">
              <label for="userLicenseType" class="form-label">License Type</label>
              <input type="text" class="form-control" id="userLicenseType" required/>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="userLicenseExpiry" class="form-label">License Expiry Date</label>
              <input type="date" class="form-control" id="userLicenseExpiry" required/>
            </div>
            <div class="col-md-6">
              <label for="userLicenseFile" class="form-label">Upload License Photo</label>
              <input type="file" class="form-control" id="userLicenseFile" accept="image/*" required/>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Add User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" id="editUserId"/>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editUserName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="editUserName" required/>
            </div>
            <div class="col-md-6">
              <label for="editUserContact" class="form-label">Contact Info</label>
              <input type="text" class="form-control" id="editUserContact" required/>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editUserRole" class="form-label">Job Title/Role</label>
              <input type="text" class="form-control" id="editUserRole" required/>
            </div>
            <div class="col-md-6">
              <label for="editUserLicenseType" class="form-label">License Type</label>
              <input type="text" class="form-control" id="editUserLicenseType" required/>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editUserLicenseExpiry" class="form-label">License Expiry Date</label>
              <input type="date" class="form-control" id="editUserLicenseExpiry" required/>
            </div>
            <div class="col-md-6">
              <label for="editUserLicenseFile" class="form-label">Upload License Photo</label>
              <input type="file" class="form-control" id="editUserLicenseFile" accept="image/*"/>
              <small class="form-text text-muted">Leave blank to keep existing photo.</small>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Update User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Add Vehicle Modal -->
<div class="modal fade" id="addVehicleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Vehicle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="vehicleForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="vehicleMake" class="form-label">Make/Model</label>
              <input type="text" class="form-control" id="vehicleMake" required/>
            </div>
            <div class="col-md-6">
              <label for="vehicleReg" class="form-label">Registration Number</label>
              <input type="text" class="form-control" id="vehicleReg" required/>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="vehicleMaintenance" class="form-label">Maintenance Date</label>
              <input type="date" class="form-control" id="vehicleMaintenance" required/>
            </div>
            <div class="col-md-6">
              <label for="vehicleInsurance" class="form-label">Insurance Details</label>
              <input type="text" class="form-control" id="vehicleInsurance" required/>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Add Vehicle</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Vehicle Modal -->
<div class="modal fade" id="editVehicleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Vehicle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editVehicleForm">
          <input type="hidden" id="editVehicleId"/>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editVehicleMake" class="form-label">Make/Model</label>
              <input type="text" class="form-control" id="editVehicleMake" required/>
            </div>
            <div class="col-md-6">
              <label for="editVehicleReg" class="form-label">Registration Number</label>
              <input type="text" class="form-control" id="editVehicleReg" required/>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editVehicleMaintenance" class="form-label">Maintenance Date</label>
              <input type="date" class="form-control" id="editVehicleMaintenance" required/>
            </div>
            <div class="col-md-6">
              <label for="editVehicleInsurance" class="form-label">Insurance Details</label>
              <input type="text" class="form-control" id="editVehicleInsurance" required/>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Update Vehicle</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Add Incident Modal -->
<div class="modal fade" id="addIncidentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Report Incident</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="incidentForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="incidentDateTime" class="form-label">Date & Time</label>
              <input type="datetime-local" class="form-control" id="incidentDateTime" required/>
            </div>
            <div class="col-md-6">
              <label for="incidentStatus" class="form-label">Status</label>
              <select class="form-select" id="incidentStatus" required>
                <option value="Pending">Pending</option>
                <option value="Under Review">Under Review</option>
                <option value="Resolved">Resolved</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="incidentDesc" class="form-label">Description</label>
            <textarea class="form-control" id="incidentDesc" rows="3" required></textarea>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="incidentEmployee" class="form-label">Affected User</label>
              <select class="form-select" id="incidentEmployee" required>
                <option value="">Select</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="incidentVehicle" class="form-label">Affected Vehicle</label>
              <select class="form-select" id="incidentVehicle" required>
                <option value="">Select</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="incidentEvidence" class="form-label">Upload Evidence (Optional)</label>
            <input type="file" class="form-control" id="incidentEvidence" accept="image/*"/>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Report Incident</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Incident Modal -->
<div class="modal fade" id="editIncidentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Incident</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editIncidentForm">
          <input type="hidden" id="editIncidentId"/>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editIncidentDateTime" class="form-label">Date & Time</label>
              <input type="datetime-local" class="form-control" id="editIncidentDateTime" required/>
            </div>
            <div class="col-md-6">
              <label for="editIncidentStatus" class="form-label">Status</label>
              <select class="form-select" id="editIncidentStatus" required>
                <option value="Pending">Pending</option>
                <option value="Under Review">Under Review</option>
                <option value="Resolved">Resolved</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="editIncidentDesc" class="form-label">Description</label>
            <textarea class="form-control" id="editIncidentDesc" rows="3" required></textarea>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editIncidentEmployee" class="form-label">Affected User</label>
              <select class="form-select" id="editIncidentEmployee" required>
                <option value="">Select</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editIncidentVehicle" class="form-label">Affected Vehicle</label>
              <select class="form-select" id="editIncidentVehicle" required>
                <option value="">Select</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="editIncidentEvidence" class="form-label">Upload Evidence (Optional)</label>
            <input type="file" class="form-control" id="editIncidentEvidence" accept="image/*"/>
            <small class="form-text text-muted">Leave blank to keep existing evidence.</small>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Update Incident</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Add Document Modal -->
<div class="modal fade" id="addDocumentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="documentForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="docName" class="form-label">Document Name</label>
              <input type="text" class="form-control" id="docName" required/>
            </div>
            <div class="col-md-6">
              <label for="docType" class="form-label">File Type</label>
              <input type="text" class="form-control" id="docType" required/>
            </div>
          </div>
          <div class="mb-3">
            <label for="docFile" class="form-label">Select File</label>
            <input type="file" class="form-control" id="docFile" required/>
          </div>
          <button type="submit" class="btn btn-primary btn-shadow">Upload</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- View Photo Modal (for license or evidence) -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">View Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="viewPhotoModalImg" src="#" alt="Photo Preview"/>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Main JS -->
<script>
  let usersData = [];
  let vehiclesData = [];
  let incidentsData = [];
  let documentsData = [];

  function saveAll() {
    localStorage.setItem('usersData', JSON.stringify(usersData));
    localStorage.setItem('vehiclesData', JSON.stringify(vehiclesData));
    localStorage.setItem('incidentsData', JSON.stringify(incidentsData));
    localStorage.setItem('documentsData', JSON.stringify(documentsData));
  }
  function loadAll() {
    usersData = JSON.parse(localStorage.getItem('usersData')) || [];
    vehiclesData = JSON.parse(localStorage.getItem('vehiclesData')) || [];
    incidentsData = JSON.parse(localStorage.getItem('incidentsData')) || [];
    documentsData = JSON.parse(localStorage.getItem('documentsData')) || [];
  }

  // Navigation
  const navLinks = document.querySelectorAll('.navLink');
  navLinks.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      let target = link.getAttribute('data-target');
      showSection(target);
      navLinks.forEach(lnk => lnk.classList.remove('active'));
      link.classList.add('active');
    });
  });

  function showSection(sectionId) {
    document.querySelectorAll('.content section').forEach(sec => {
      sec.id === sectionId ? sec.classList.remove('hidden-section') : sec.classList.add('hidden-section');
    });
    updateAll();
  }

  function updateAll() {
    renderUsers();
    renderVehicles();
    renderIncidents();
    renderDocuments();
    updateDashboard();
    updateCompliance();
    updateDashboardChart();
    updateReportsChart();
    populateIncidentSelects();
    populateVehicleFilter();
    saveAll();
  }

  // USERS
  const usersTableBody = document.getElementById('usersTable').getElementsByTagName('tbody')[0];
  function renderUsers() {
    usersTableBody.innerHTML = '';
    let filtered = filterUsers(true);
    if (!filtered.length) {
      let row = usersTableBody.insertRow();
      row.classList.add('no-data-row');
      row.innerHTML = `<td colspan="5">No data found</td>`;
      return;
    }
    filtered.forEach(usr => {
      let row = usersTableBody.insertRow();
      row.insertCell(0).textContent = usr.name;
      row.insertCell(1).textContent = usr.contact;
      row.insertCell(2).textContent = usr.role;
      row.insertCell(3).textContent = `${usr.licenseType} (Exp: ${usr.licenseExpiry})`;
      row.insertCell(4).innerHTML = `
        <button class="btn btn-sm btn-primary me-1" onclick="viewLicensePhoto('${usr.licensePhoto}')">View Photo</button>
        <button class="btn btn-sm btn-warning me-1" onclick="loadUserEdit('${usr.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteUser('${usr.id}')">Delete</button>
      `;
    });
  }
  function filterUsers(renderLater = false) {
    let searchVal = document.getElementById('usersSearch').value.trim().toLowerCase();
    let filterVal = document.getElementById('usersFilter').value;
    let arr = usersData.filter(u => {
      let passSearch = !searchVal || u.name.toLowerCase().includes(searchVal) || (u.contact||'').toLowerCase().includes(searchVal) || (u.role||'').toLowerCase().includes(searchVal);
      let passFilter = !filterVal || (u.role||'').toLowerCase() === filterVal.toLowerCase();
      return passSearch && passFilter;
    });
    if (!renderLater) renderUsers();
    return arr;
  }
  document.getElementById('userForm').addEventListener('submit', e => {
    e.preventDefault();
    let name = document.getElementById('userName').value.trim();
    let contact = document.getElementById('userContact').value.trim();
    let role = document.getElementById('userRole').value.trim();
    let licenseType = document.getElementById('userLicenseType').value.trim();
    let licenseExpiry = document.getElementById('userLicenseExpiry').value.trim();
    let licenseFile = document.getElementById('userLicenseFile').files[0];
    let newUser = { 
      id: Date.now().toString(), 
      name, 
      contact, 
      role, 
      licenseType, 
      licenseExpiry
    };
    if (licenseFile) {
      let reader = new FileReader();
      reader.onload = evt => {
        newUser.licensePhoto = evt.target.result;
        usersData.push(newUser);
        updateAll();
        let modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
        modal.hide();
        e.target.reset();
      };
      reader.readAsDataURL(licenseFile);
    } else {
      newUser.licensePhoto = null;
      usersData.push(newUser);
      updateAll();
      let modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
      modal.hide();
      e.target.reset();
    }
  });
  function loadUserEdit(id) {
    let usr = usersData.find(u => u.id === id);
    if (!usr) return;
    document.getElementById('editUserId').value = usr.id;
    document.getElementById('editUserName').value = usr.name;
    document.getElementById('editUserContact').value = usr.contact;
    document.getElementById('editUserRole').value = usr.role;
    document.getElementById('editUserLicenseType').value = usr.licenseType;
    document.getElementById('editUserLicenseExpiry').value = usr.licenseExpiry;
    let modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
  }
  document.getElementById('editUserForm').addEventListener('submit', e => {
    e.preventDefault();
    let id = document.getElementById('editUserId').value;
    let name = document.getElementById('editUserName').value.trim();
    let contact = document.getElementById('editUserContact').value.trim();
    let role = document.getElementById('editUserRole').value.trim();
    let licenseType = document.getElementById('editUserLicenseType').value.trim();
    let licenseExpiry = document.getElementById('editUserLicenseExpiry').value.trim();
    let licenseFile = document.getElementById('editUserLicenseFile').files[0];
    let usr = usersData.find(u => u.id === id);
    if (!usr) return;
    usr.name = name;
    usr.contact = contact;
    usr.role = role;
    usr.licenseType = licenseType;
    usr.licenseExpiry = licenseExpiry;
    if (licenseFile) {
      let reader = new FileReader();
      reader.onload = evt => {
        usr.licensePhoto = evt.target.result;
        updateAll();
        let modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
        modal.hide();
        e.target.reset();
      };
      reader.readAsDataURL(licenseFile);
    } else {
      updateAll();
      let modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
      modal.hide();
      e.target.reset();
    }
  });
  function deleteUser(id) {
    if (!confirm('Delete this user?')) return;
    incidentsData.forEach(i => { if (i.employeeId === id) i.employeeId = ''; });
    usersData = usersData.filter(u => u.id !== id);
    updateAll();
  }
  function viewLicensePhoto(base64) {
    if (!base64) { alert('No photo to view'); return; }
    document.getElementById('viewPhotoModalImg').src = base64;
    let modal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
    modal.show();
  }

  // VEHICLES
  const vehiclesTableBody = document.getElementById('vehiclesTable').getElementsByTagName('tbody')[0];
  function renderVehicles() {
    vehiclesTableBody.innerHTML = '';
    let filtered = filterVehicles(true);
    if (!filtered.length) {
      let row = vehiclesTableBody.insertRow();
      row.classList.add('no-data-row');
      row.innerHTML = `<td colspan="6">No data found</td>`;
      return;
    }
    filtered.forEach(veh => {
      let row = vehiclesTableBody.insertRow();
      row.insertCell(0).textContent = veh.make;
      row.insertCell(1).textContent = veh.registration;
      row.insertCell(2).textContent = veh.driverName || 'Unassigned';
      row.insertCell(3).textContent = veh.maintenance;
      row.insertCell(4).textContent = veh.insurance;
      row.insertCell(5).innerHTML = `
        <button class="btn btn-sm btn-primary me-1" onclick="viewVehicle('${veh.id}')">View</button>
        <button class="btn btn-sm btn-warning me-1" onclick="loadVehicleEdit('${veh.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteVehicle('${veh.id}')">Delete</button>
      `;
    });
  }
  function filterVehicles(renderLater = false) {
    let searchVal = document.getElementById('vehiclesSearch').value.trim().toLowerCase();
    let filterVal = document.getElementById('vehiclesFilter').value;
    let arr = vehiclesData.filter(v => {
      let passSearch = !searchVal || v.make.toLowerCase().includes(searchVal) || v.registration.toLowerCase().includes(searchVal) || (v.driverName||'').toLowerCase().includes(searchVal);
      let passFilter = !filterVal || ((v.driverName||'').toLowerCase() === filterVal.toLowerCase());
      return passSearch && passFilter;
    });
    if (!renderLater) renderVehicles();
    return arr;
  }
  function populateVehicleFilter() {
    let drivers = [...new Set(vehiclesData.map(v => v.driverName).filter(x => x))];
    let sel = document.getElementById('vehiclesFilter');
    let val = sel.value;
    sel.innerHTML = `<option value="">All Drivers</option>`;
    drivers.forEach(d => {
      if (d) sel.innerHTML += `<option value="${d}">${d}</option>`;
    });
    sel.value = val;
  }
  document.getElementById('vehicleForm').addEventListener('submit', e => {
    e.preventDefault();
    let make = document.getElementById('vehicleMake').value.trim();
    let reg = document.getElementById('vehicleReg').value.trim();
    let maintenance = document.getElementById('vehicleMaintenance').value.trim();
    let insurance = document.getElementById('vehicleInsurance').value.trim();
    let id = Date.now().toString();
    vehiclesData.push({ id, make, registration: reg, maintenance, insurance, driverName: '' });
    updateAll();
    let modal = bootstrap.Modal.getInstance(document.getElementById('addVehicleModal'));
    modal.hide();
    e.target.reset();
  });
  function loadVehicleEdit(id) {
    let veh = vehiclesData.find(v => v.id === id);
    if (!veh) return;
    document.getElementById('editVehicleId').value = veh.id;
    document.getElementById('editVehicleMake').value = veh.make;
    document.getElementById('editVehicleReg').value = veh.registration;
    document.getElementById('editVehicleMaintenance').value = veh.maintenance;
    document.getElementById('editVehicleInsurance').value = veh.insurance;
    let modal = new bootstrap.Modal(document.getElementById('editVehicleModal'));
    modal.show();
  }
  document.getElementById('editVehicleForm').addEventListener('submit', e => {
    e.preventDefault();
    let id = document.getElementById('editVehicleId').value;
    let make = document.getElementById('editVehicleMake').value.trim();
    let reg = document.getElementById('editVehicleReg').value.trim();
    let maintenance = document.getElementById('editVehicleMaintenance').value.trim();
    let insurance = document.getElementById('editVehicleInsurance').value.trim();
    let veh = vehiclesData.find(v => v.id === id);
    if (!veh) return;
    veh.make = make;
    veh.registration = reg;
    veh.maintenance = maintenance;
    veh.insurance = insurance;
    updateAll();
    let modal = bootstrap.Modal.getInstance(document.getElementById('editVehicleModal'));
    modal.hide();
    e.target.reset();
  });
  function deleteVehicle(id) {
    if (!confirm('Delete vehicle?')) return;
    incidentsData.forEach(inc => { if (inc.vehicleId === id) inc.vehicleId = ''; });
    vehiclesData = vehiclesData.filter(v => v.id !== id);
    updateAll();
  }
  function viewVehicle(id) {
    let veh = vehiclesData.find(v => v.id === id);
    if (!veh) return;
    alert(`Make: ${veh.make}\nRegistration: ${veh.registration}\nMaintenance: ${veh.maintenance}\nInsurance: ${veh.insurance}`);
  }

  // INCIDENTS
  const incidentsTableBody = document.getElementById('incidentsTable').getElementsByTagName('tbody')[0];
  function renderIncidents() {
    incidentsTableBody.innerHTML = '';
    let filtered = filterIncidents(true);
    if (!filtered.length) {
      let row = incidentsTableBody.insertRow();
      row.classList.add('no-data-row');
      row.innerHTML = `<td colspan="6">No data found</td>`;
      return;
    }
    filtered.forEach(inc => {
      let row = incidentsTableBody.insertRow();
      row.insertCell(0).textContent = new Date(inc.dateTime).toLocaleString();
      row.insertCell(1).textContent = inc.description;
      let empObj = usersData.find(u => u.id === inc.employeeId);
      row.insertCell(2).textContent = empObj ? empObj.name : 'N/A';
      let vehObj = vehiclesData.find(v => v.id === inc.vehicleId);
      row.insertCell(3).textContent = vehObj ? vehObj.make : 'N/A';
      row.insertCell(4).textContent = inc.status;
      row.insertCell(5).innerHTML = `
        <button class="btn btn-sm btn-primary me-1" onclick="viewIncident('${inc.id}')">View</button>
        <button class="btn btn-sm btn-warning me-1" onclick="loadIncidentEdit('${inc.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteIncident('${inc.id}')">Delete</button>
      `;
    });
  }
  function filterIncidents(renderLater = false) {
    let searchVal = document.getElementById('incidentsSearch').value.trim().toLowerCase();
    let filterVal = document.getElementById('incidentsFilter').value;
    let arr = incidentsData.filter(i => {
      let passSearch = !searchVal || i.description.toLowerCase().includes(searchVal);
      let passFilter = !filterVal || i.status === filterVal;
      return passSearch && passFilter;
    });
    if (!renderLater) renderIncidents();
    return arr;
  }
  document.getElementById('incidentForm').addEventListener('submit', e => {
    e.preventDefault();
    let dateTime = document.getElementById('incidentDateTime').value.trim();
    let status = document.getElementById('incidentStatus').value;
    let desc = document.getElementById('incidentDesc').value.trim();
    let emp = document.getElementById('incidentEmployee').value;
    let veh = document.getElementById('incidentVehicle').value;
    let file = document.getElementById('incidentEvidence').files[0];
    let newInc = { 
      id: Date.now().toString(), 
      dateTime, 
      status, 
      description: desc, 
      employeeId: emp, 
      vehicleId: veh 
    };
    if (file) {
      let reader = new FileReader();
      reader.onload = evt => {
        newInc.evidence = evt.target.result;
        incidentsData.push(newInc);
        updateAll();
        let modal = bootstrap.Modal.getInstance(document.getElementById('addIncidentModal'));
        modal.hide();
        e.target.reset();
      };
      reader.readAsDataURL(file);
    } else {
      newInc.evidence = '';
      incidentsData.push(newInc);
      updateAll();
      let modal = bootstrap.Modal.getInstance(document.getElementById('addIncidentModal'));
      modal.hide();
      e.target.reset();
    }
  });
  function loadIncidentEdit(id) {
    let inc = incidentsData.find(i => i.id === id);
    if (!inc) return;
    document.getElementById('editIncidentId').value = inc.id;
    document.getElementById('editIncidentDateTime').value = inc.dateTime;
    document.getElementById('editIncidentStatus').value = inc.status;
    document.getElementById('editIncidentDesc').value = inc.description;
    document.getElementById('editIncidentEmployee').value = inc.employeeId || '';
    document.getElementById('editIncidentVehicle').value = inc.vehicleId || '';
    let modal = new bootstrap.Modal(document.getElementById('editIncidentModal'));
    modal.show();
  }
  document.getElementById('editIncidentForm').addEventListener('submit', e => {
    e.preventDefault();
    let id = document.getElementById('editIncidentId').value;
    let dateTime = document.getElementById('editIncidentDateTime').value.trim();
    let status = document.getElementById('editIncidentStatus').value;
    let desc = document.getElementById('editIncidentDesc').value.trim();
    let emp = document.getElementById('editIncidentEmployee').value;
    let veh = document.getElementById('editIncidentVehicle').value;
    let file = document.getElementById('editIncidentEvidence').files[0];
    let inc = incidentsData.find(i => i.id === id);
    if (!inc) return;
    inc.dateTime = dateTime;
    inc.status = status;
    inc.description = desc;
    inc.employeeId = emp;
    inc.vehicleId = veh;
    if (file) {
      let reader = new FileReader();
      reader.onload = evt => {
        inc.evidence = evt.target.result;
        updateAll();
        let modal = bootstrap.Modal.getInstance(document.getElementById('editIncidentModal'));
        modal.hide();
        e.target.reset();
      };
      reader.readAsDataURL(file);
    } else {
      updateAll();
      let modal = bootstrap.Modal.getInstance(document.getElementById('editIncidentModal'));
      modal.hide();
      e.target.reset();
    }
  });
  function deleteIncident(id) {
    if (!confirm('Delete this incident?')) return;
    incidentsData = incidentsData.filter(i => i.id !== id);
    updateAll();
  }
  function viewIncident(id) {
    let inc = incidentsData.find(i => i.id === id);
    if (!inc) return;
    let e = usersData.find(u => u.id === inc.employeeId);
    let v = vehiclesData.find(x => x.id === inc.vehicleId);
    alert(`Date: ${new Date(inc.dateTime).toLocaleString()}\nStatus: ${inc.status}\nDesc: ${inc.description}\nUser: ${e? e.name : 'N/A'}\nVehicle: ${v? v.make : 'N/A'}`);
  }

  // DOCUMENTS
  const documentsTableBody = document.getElementById('documentsTable').getElementsByTagName('tbody')[0];
  function renderDocuments() {
    documentsTableBody.innerHTML = '';
    if (!documentsData.length) {
      let row = documentsTableBody.insertRow();
      row.classList.add('no-data-row');
      row.innerHTML = `<td colspan="5">No documents found</td>`;
      return;
    }
    documentsData.forEach(doc => {
      let row = documentsTableBody.insertRow();
      row.insertCell(0).textContent = doc.name;
      row.insertCell(1).textContent = doc.type;
      row.insertCell(2).textContent = doc.uploadedBy || 'Unknown';
      row.insertCell(3).innerHTML = doc.base64 
        ? `<button class="btn btn-sm btn-primary" onclick="viewDocPhoto('${doc.base64}')">View</button>` 
        : 'No Preview';
      row.insertCell(4).innerHTML = `<button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.id}')">Delete</button>`;
    });
  }
  document.getElementById('documentForm').addEventListener('submit', e => {
    e.preventDefault();
    let name = document.getElementById('docName').value.trim();
    let type = document.getElementById('docType').value.trim();
    let file = document.getElementById('docFile').files[0];
    if (!file) return alert('Please select a file');
    let docObj = { 
      id: Date.now().toString(), 
      name, 
      type, 
      base64: '', 
      uploadedBy: 'System' 
    };
    let reader = new FileReader();
    reader.onload = evt => {
      docObj.base64 = evt.target.result;
      documentsData.push(docObj);
      updateAll();
      let modal = bootstrap.Modal.getInstance(document.getElementById('addDocumentModal'));
      modal.hide();
      e.target.reset();
    };
    reader.readAsDataURL(file);
  });
  function deleteDocument(id) {
    if (!confirm('Delete this document?')) return;
    documentsData = documentsData.filter(d => d.id !== id);
    updateAll();
  }
  function viewDocPhoto(base64) {
    document.getElementById('viewPhotoModalImg').src = base64;
    let modal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
    modal.show();
  }

  // COMPLIANCE / NOTIFICATIONS
  function updateDashboard() {
    let now = new Date();
    let next30 = new Date(); 
    next30.setDate(now.getDate() + 30);

    // License Expiry
    let licCount = usersData.filter(u => new Date(u.licenseExpiry) <= next30).length;
    // Overdue Vehicle Maintenance
    let overdueVeh = vehiclesData.filter(v => new Date(v.maintenance) < now).length;

    document.getElementById('licenseExpiryCount').textContent = licCount;
    document.getElementById('overdueChecksCount').textContent = overdueVeh;
  }
  function updateCompliance() {
    let now = new Date();
    let next30 = new Date(); 
    next30.setDate(now.getDate() + 30);

    let licCount = usersData.filter(u => new Date(u.licenseExpiry) <= next30).length;
    let overdueVeh = vehiclesData.filter(v => new Date(v.maintenance) < now).length;

    document.getElementById('licenseRenewalsCount').textContent = licCount;
    document.getElementById('vehicleInspectionsCount').textContent = overdueVeh;
  }

  // CHARTS
  let dashChart, reportsChart;
  function updateDashboardChart() {
    // Incidents per Month
    let monthlyIncidents = Array(12).fill(0);
    incidentsData.forEach(inc => {
      let m = new Date(inc.dateTime).getMonth();
      monthlyIncidents[m]++;
    });
    if (dashChart) dashChart.destroy();
    const ctx = document.getElementById('dashboardChart').getContext('2d');
    dashChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        datasets: [
          {
            label: 'Incidents',
            data: monthlyIncidents,
            backgroundColor: 'rgba(255,99,132,0.6)'
          }
        ]
      },
      options: { responsive: true }
    });
  }
  function updateReportsChart() {
    if (reportsChart) reportsChart.destroy();
    let ctx = document.getElementById('reportsChart').getContext('2d');
    let userNames = usersData.map(u => u.name);
    // Simple example: compliance = license valid => 100, else 50
    let complianceRates = usersData.map(u => {
      let isLicenseValid = new Date(u.licenseExpiry) > new Date() ? 100 : 50;
      return isLicenseValid;
    });
    reportsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: userNames,
        datasets: [{
          label: 'Compliance Rate (%)',
          data: complianceRates,
          backgroundColor: 'rgba(255,206,86,0.6)',
          borderColor: 'rgba(255,206,86,1)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        scales: { x: { beginAtZero:true, max:100 } },
        plugins: { legend:{ display:false } }
      }
    });
  }

  // Incidents drop-downs
  function populateIncidentSelects() {
    let incEmp = document.getElementById('incidentEmployee');
    let incVeh = document.getElementById('incidentVehicle');
    let incEmp2 = document.getElementById('editIncidentEmployee');
    let incVeh2 = document.getElementById('editIncidentVehicle');
    [incEmp, incEmp2].forEach(sel => {
      let val = sel.value;
      sel.innerHTML = `<option value="">Select</option>`;
      usersData.forEach(u => {
        sel.innerHTML += `<option value="${u.id}">${u.name}</option>`;
      });
      sel.value = val;
    });
    [incVeh, incVeh2].forEach(sel => {
      let val = sel.value;
      sel.innerHTML = `<option value="">Select</option>`;
      vehiclesData.forEach(v => {
        sel.innerHTML += `<option value="${v.id}">${v.make}</option>`;
      });
      sel.value = val;
    });
  }

  // UTILS: Export CSV, PDF
  function exportToCSV(section) {
    let data = [];
    let filename = section + '.csv';
    if (section === 'users') data = usersData;
    else if (section === 'vehicles') data = vehiclesData;
    else if (section === 'incidents') data = incidentsData;
    else if (section === 'documents') data = documentsData;
    if (!data.length) return alert('No data to export');

    let keys = Object.keys(data[0]);
    let csv = keys.join(',') + '\n';
    data.forEach(obj => {
      let row = keys.map(k => `"${(obj[k]||'').toString().replace(/"/g,'""')}"`).join(',');
      csv += row + '\n';
    });
    let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }
  function exportToPDF(section) {
    alert('PDF export for '+section+' not fully implemented; would require a PDF library (e.g. jsPDF).');
  }
  function exportReportsPDF() {
    alert('Exporting detailed reports as PDF is not fully implemented here.');
  }

  // On Load
  document.addEventListener('DOMContentLoaded', () => {
    loadAll();
    showSection('dashboardSection');
  });
</script>
</body>
</html>
